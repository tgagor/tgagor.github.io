<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The best way to get NVM working in CI/CD systems | Tom's Blog</title><meta name=keywords content="NVM in CI/CD,Node Version Manager,CI/CD Node.js setup,DevOps best practices,Docker Node.js management,Node.js version control"><meta name=description content="Learn the best way to get NVM (Node Version Manager) working in CI/CD systems, ensuring seamless Node.js version management in your DevOps workflows."><meta name=author content="timor"><link rel=canonical href=https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/><link crossorigin=anonymous href=/assets/css/stylesheet.dd9b399756d51cbc22dd492f8bc5e6baa73d268548ef7584ed5740fe95fdcbce.css integrity="sha256-3Zs5l1bVHLwi3Ukvi8Xmuqc9JoVI73WE7VdA/pX9y84=" rel="preload stylesheet" as=style><link rel=icon href=https://gagor.pro/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gagor.pro/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gagor.pro/favicon-32x32.png><link rel=apple-touch-icon href=https://gagor.pro/apple-touch-icon.png><link rel=mask-icon href=https://gagor.pro/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta name=fediverse:creator content="@tgagor@mastodon.social"><link rel=me hreflang=en href=https://mastodon.social/@tgagor><meta property="og:url" content="https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/"><meta property="og:site_name" content="Tom's Blog"><meta property="og:title" content="The best way to get NVM working in CI/CD systems"><meta property="og:description" content="Learn the best way to get NVM (Node Version Manager) working in CI/CD systems, ensuring seamless Node.js version management in your DevOps workflows."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-01T22:40:20+01:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Bash"><meta property="article:tag" content="Docker"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Best Practices"><meta property="og:image" content="https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover.webp"><meta name=twitter:title content="The best way to get NVM working in CI/CD systems"><meta name=twitter:description content="Learn the best way to get NVM (Node Version Manager) working in CI/CD systems, ensuring seamless Node.js version management in your DevOps workflows."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gagor.pro/posts/"},{"@type":"ListItem","position":2,"name":"The best way to get NVM working in CI/CD systems","item":"https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The best way to get NVM working in CI/CD systems","name":"The best way to get NVM working in CI\/CD systems","description":"Learn the best way to get NVM (Node Version Manager) working in CI/CD systems, ensuring seamless Node.js version management in your DevOps workflows.","keywords":["NVM in CI/CD","Node Version Manager","CI/CD Node.js setup","DevOps best practices","Docker Node.js management","Node.js version control"],"articleBody":"TL;DR While reasoning is important, readers may not be interested in all the frustrations I experienced while figuring out how to get things done. If you‚Äôre looking for a quick solution, skip to the ‚ÄúWhat eventually worked?‚Äù section. However, if you‚Äôre interested in the thought process behind the solution, keep reading.\nWhy? Some might bother why the hell I‚Äôd like to make my life so hard? ü§£\nWe used to use nodeenv‚Äâexternal link for that purpose. It provides a simple script that allows to fetch any version of Node. You have to configure PATH variable and you‚Äôre done. It‚Äôs very simple from the perspective of Docker images operator. There‚Äôs one problem with nodeenv comparing it to the nvm - popularity.\nnodeenv nvm I was explaining to a lot of people, how to use nodeenv. No one knew it! But many of them knew nvm and were asking: Why can‚Äôt I just install version of Node that my project needs with NVM? That‚Äôs how I started thinking about better ways to deal with Node version management.\nI‚Äôm supporting organization with thousands of projects. Node projects can be counted in hundreds. It‚Äôs not possible to provide up to date base images for all the Node versions that people would request. But I can provide a base, which would allow to install any Node version you need on up to date base images. That‚Äôs what this article is about.\nNVM is nice and simple, how hard it might be to get it working with CI/CD? Over the past few days, I‚Äôve been working on providing nvm‚Äâexternal link for both my company‚Äôs Docker base images and for CI/CD. However, it hasn‚Äôt been an easy task.\nIn general, nvm (know as Node Version Manager) is loved by frontend developers because it allows them to drop a .nvmrc file in their project, and each time they switch between projects, everything works seamlessly. nvm is responsible for installing (or activating) the version of Node required by a specific project. A similar functionality is provided by nodeenv‚Äâexternal link , which is Python-based and based on virtualenv‚Äâexternal link .\nWhile setting up nodeenv is straightforward because it‚Äôs a regular CLI command, nvm is not. When you follow nvm‚Äôs installation instructions1, you end up with something like the following code in one of the startup files (~/.bashrc, ~/.profile, or ~/.zshrc):\nTypical nvm installation in ~/.bashrc export NVM_DIR=\"$HOME/.nvm\" [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" [ -s \"$NVM_DIR/bash_completion\" ] \u0026\u0026 . \"$NVM_DIR/bash_completion\" Installing nvm involves ‚Äúsourcing‚Äù (that‚Äôs what . do) nvm.sh with some shell functions into your current shell. This is not a big deal for your local machine, but it becomes an issue if you want to use nvm in non-interactive shells for your CI/CD.\nLet‚Äôs take bash as an example. Suddenly, it becomes important to know which file you‚Äôve put the nvm lines in because not all of them are loaded for non-interactive shells2. The startup files for bash (in order) are:\nInteractive (called with --login) /etc/profile ~/.bash_profile ~/.bash_login ~/.profile Non-interactive ~/.bashrc It‚Äôs worth noting that ~/.profile usually loads ~/.bashrc automatically (check yours). But what about sh, dash or zsh? If you‚Äôre calling nvm on Jenkins, what shell will it call? These varieties of combinations make it incredibly hard to make nvm behave consistently.\nTo better understand my use case, I use:\nJenkins‚Äâexternal link for CI/CD Which runs as a Docker container on a K8S cluster The container contains most of the tools needed by developers (but just single LTS version of Node). Getting it working in the Dockerfile I eventually found a nice way to make nvm work in a Dockerfile - by using the SHELL directive‚Äâexternal link . By default, it‚Äôs set to: [\"/bin/sh\", \"-c\"].\nThis shell does not load the files we need and starts a non-interactive shell. We can fix it with:\nEnforcing interactive shell in the Dockerfile SHELL [\"/usr/bin/bash\", \"--login\", \"-c\"] The whole Dockerfile might look like this: Example Dockerfile FROM ubuntu:22.04 as fetcher ENV NVM_VERSION v0.39.3 RUN apt-get update \u0026\u0026 \\ apt-get install -y git \u0026\u0026 \\ git clone \\ --depth 1 \\ --branch $NVM_VERSION \\ https://github.com/nvm-sh/nvm.git FROM ubuntu:22.04 # we don't want to store cached files in the image VOLUME /var/cache/apt # prerequisites RUN apt-get update \u0026\u0026 \\ apt-get install -y curl SHELL [\"/bin/bash\", \"--login\", \"-c\"] ENV NVM_DIR=/opt/nvm # copy the nvm COPY --from=fetcher nvm $NVM_DIR # change ownership if needed RUN chown -R $(id -un):$(id -gn) $NVM_DIR \u0026\u0026 \\ echo '[ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" --no-use' \u003e\u003e ~/.profile What happen here?\nA shallow clone of the nvm repository is performed with git and it‚Äôs pinned to a specific version.\nThe final image requires some dependencies such as bash and curl.\nThe SHELL is set to pretend interactive.\nThe nvm files are copied to /opt/nvm.\nchown is used to set the ownership of the files.\nThe steps in the installation guide1 are followed with some exceptions such as setting the NVM_DIR environment variable directly in the Dockerfile, and skipping bash completion.\nThe sourcing of nvm.sh is followed by --no-use to lazily load nvm so that it‚Äôs not loaded until it‚Äôs used3.\nLastly, you can test if it‚Äôs working by adding some commands at the end of the Dockerfile to check the nvm version, install different versions of Node, and check their versions as well.\nGetting it working in Jenkins The pattern of running Jenkins agents as containers is great for packing development tools into Docker images and running them when needed. However, it can be challenging to get nvm.sh sourced properly when Jenkins agents are started as containers.\nNow that we have a working nvm in Docker image, we can use it in Jenkins. The easiest way is to use the Docker image we created above, as a base for a custom Jenkins agent image which includes nvm and all the necessary Node versions.\nExample Dockerfile:\nJenkins agent Dockerfile FROM our-company/our-nvm-base:latest # you might need to create jenkins user earlier USER jenkins ENV NODE_VERSIONS=\"lts/* 16\" # install Node versions RUN nvm install $NODE_VERSIONS \u0026\u0026 \\ nvm use \"lts/*\" \u0026\u0026 \\ npm install -g yarn And that‚Äôs it! Right? ü§î\nWas it enough to get it working? Not really üòï. Why?\nIt all depends how do you call the commands. While it works well during the build time, it may not work when running the container or calling commands in different ways.\nFor example, it may not work if you use docker exec to run commands in containers - which we do when we test Docker base images. Similar situation happen when sh commands are used in Jenkins pipelines, ~/.profile is not loaded, and so nvm.sh is not sourced properly. While it‚Äôs possible to teach users to source nvm.sh in every sh command, this can be cumbersome and error-prone. Therefore, we need a better solution.\nWhat eventually worked? After struggling with the previous approach, I started thinking of an easier and more straightforward way to work with nvm and avoid common mistakes. I wanted something that would work the same way on both my local machine and in the CI/CD environment.\nI realized that there were two main things that nvm did: managing installations of different Node versions and loading them on demand by modifying the PATH environment variable.\nWhile thinking about how to simplify this process, it occurred to me that it would be much easier if nvm was a command rather than a bash function. And then, it hit me ‚Äì why not make nvm a command?\nTo do this, I created a file with the following code: First try on nvm wrapper #!/usr/bin/env bash # load nvm [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" # call nvm with all the parameters nvm $@ Next, I made this file executable and available for execution by writing it to /usr/local/bin/nvm, ~/.bin/nvm, or ~/.local/bin/nvm - whatever works for you.\nWith this solution, there was no longer any need to source nvm.sh so we could use nvm. Instead, it could be called directly as a command, which simplified and streamlined the process considerably.\nI was able to install and manage different versions of Node. However, attempting to use node or npm commands resulted in an error message stating that the command was not recognized. This is because nvm installed like that do not mangle the PATH environment variable anymore. To fix this issue, there are two potential solutions.\nThe first solution involves manually setting the PATH variable to include the desired version of Node. If you only need one specific version in your Docker image, this solution might suffice. Additionally, exposing the bin directory will automatically expose all custom binaries installed with npm.\nIt‚Äôs as easy as adding in Dockerfile of agent:\nENV PATH=$NVM_DIR/versions/node/v18.16.0/bin:$PATH The second solution involves creating wrappers for node and npm commands in the same style as the nvm command. While this approach has the downside of not automatically exposing binaries installed via npm, it is a great idea overall. By running node wrapper, we can guess which version of Node should be used by sourcing nvm and running it.\nHere are examples of the wrapper scripts for node and npm:\nWrapper script for node: Node wrapper #!/usr/bin/env bash [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" exec node $@ Wrapper script for npm: NPM wrapper #!/usr/bin/env bash [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" exec npm $@ I use exec here for node and npm but not for nvm because nvm is a function while node and npm are executables. By using exec to run them, we eliminate one layer of bash shell, which saves a few megabytes of RAM in the container.\nHow to automatically expose binaries installed by npm? The ‚Äúwrappers‚Äù approach has a downside: binaries installed via npm are not immediately available. They have to be wrapped or linked, or the PATH has to be modified. But we can automate this in our script!\nHere‚Äôs an improved version of /usr/local/bin/npm:\nImproved /usr/local/bin/npm #!/usr/bin/env bash [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" set -e npm $@ if [ \"$1\" == \"install\" ]; then find $(dirname $(nvm which node)) \\ -executable \\ \\( -type f -o -type l \\) \\ -print \\ | sed '/node$/d;/npm$/d' \\ | xargs -I{} ln -sf {} /usr/local/bin/ fi This script works by first executing npm $@ normally, without exec. After successful execution of npm install, it will find all the executables in the same directory as the current node executable, except for node and npm themselves, and symlink them to a directory already in the PATH, such as /usr/local/bin. Note that using /usr/local/bin will require root permissions. Alternatively, you can use ~/bin or ~/.local/bin, as long as one of these directories is in the PATH.\nWhat about npx? A colleague suggest me, that npx command should be wrapped too. I used same script as for npm but without linking after install. Final script will look like:\nExample /usr/local/bin/npx #!/usr/bin/env bash [ -s \"$NVM_DIR/nvm.sh\" ] \u0026\u0026 . \"$NVM_DIR/nvm.sh\" exec npx $@ Complete example I prepared example repo with Dockerfiles‚Äâexternal link implementing both ways + some test proving why solution with wrappers works better4.\nThis example presents a base image, which provides just NVM a top Ubuntu, without any version of Node available out of the box. You can use this base in a Docker image:\nHow to use it in the real app FROM tgagor/base-v2/nvm # copy sources COPY ./src ./ COPY .nvmrc ./ # install Node you need, set it as default, upgrade npm to latest version RUN nvm install --default --latest-npm # install your app RUN npm install ... Use those wrapper scripts in your CI/CD agents and you will be able to use NVM in the same way.\nFinal words In conclusion, managing multiple versions of Node can be a hassle, but by creating a simple wrapper script, we can make nvm a command and automate the process of exposing the correct binaries installed via npm. With these techniques, we can easily manage multiple Node versions and ensure that our development and CI/CD environments will work in the same way.\nHopefully, this article has provided some useful insights and tips for managing Node versions with nvm. Happy coding!\nWhat‚Äôs pretty interesting, I review a huge part of Internet looking for solutions like this and no one does it like me. Am I wrong? Are there better ways to achieve it?\nEnjoyed? https://github.com/nvm-sh/nvm#git-install‚Äâexternal link ‚Ü©Ô∏é¬†‚Ü©Ô∏é\nhttps://www.gnu.org/software/bash/manual/html_node/Bash-Startup-Files.html‚Äâexternal link ‚Ü©Ô∏é\nhttps://github.com/nvm-sh/nvm#additional-notes‚Äâexternal link ‚Ü©Ô∏é\nhttps://github.com/tgagor/docker-nvm-example‚Äâexternal link ‚Ü©Ô∏é\n","wordCount":"2084","inLanguage":"en","image":"https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover.webp","datePublished":"2023-04-25T00:00:00Z","dateModified":"2025-02-01T22:40:20+01:00","author":{"@type":"Person","name":"timor"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://gagor.pro/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gagor.pro/ accesskey=h title="Tom's Blog (Alt + H)"><img src=https://gagor.pro/favicon-36x36.avif alt="Page logo" aria-label=logo height=36 width=36>Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gagor.pro/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://gagor.pro/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://gagor.pro/bookshelf/ title=Bookshelf><span>Bookshelf</span></a></li><li><a href=https://gagor.pro/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://gagor.pro/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gagor.pro/>Home</a>&nbsp;¬ª&nbsp;<a href=https://gagor.pro/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">The best way to get NVM working in CI/CD systems</h1><div class=post-meta><span title='2023-04-25 00:00:00 +0000 UTC'>2023-04-25</span>&nbsp;¬∑&nbsp;10 min&nbsp;¬∑&nbsp;timor</div></header><figure class=entry-cover><img loading=eager srcset='https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover_hu_f4c25b1845c0b0c8.webp 360w,https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover_hu_3965d2944b6435b3.webp 480w,https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover_hu_c2438a22a016b544.webp 720w,https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover_hu_aae77585a78953a4.webp 1080w,https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover_hu_39b0de950c4110ce.webp 1500w,https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover.webp 1500w' src=https://gagor.pro/2023/04/the-best-way-to-get-nvm-working-in-ci-cd-systems/images/cover.webp sizes="(min-width: 768px) 720px, 100vw" width=1500 height=625 alt="[Photo by RealToughCandy.com from Pexels](https://www.pexels.com/photo/a-person-holing-a-sticker-in-close-up-photography-11035380/)"><figcaption><a href=https://www.pexels.com/photo/a-person-holing-a-sticker-in-close-up-photography-11035380/ target=_blank>Photo by RealToughCandy.com from Pexels<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span></a></figcaption></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#tldr aria-label=TL;DR>TL;DR</a></li><li><a href=#why aria-label=Why?>Why?</a></li><li><a href=#nvm-is-nice-and-simple-how-hard-it-might-be-to-get-it-working-with-cicd aria-label="NVM is nice and simple, how hard it might be to get it working with CI/CD?">NVM is nice and simple, how hard it might be to get it working with CI/CD?</a><ul><li><a href=#getting-it-working-in-the-dockerfile aria-label="Getting it working in the Dockerfile">Getting it working in the Dockerfile</a></li><li><a href=#getting-it-working-in-jenkins aria-label="Getting it working in Jenkins">Getting it working in Jenkins</a></li><li><a href=#was-it-enough-to-get-it-working aria-label="Was it enough to get it working?">Was it enough to get it working?</a></li></ul></li><li><a href=#what-eventually-worked aria-label="What eventually worked?">What eventually worked?</a><ul><li><a href=#how-to-automatically-expose-binaries-installed-by-npm aria-label="How to automatically expose binaries installed by npm?">How to automatically expose binaries installed by npm?</a></li><li><a href=#what-about-npx aria-label="What about npx?">What about npx?</a></li><li><a href=#complete-example aria-label="Complete example">Complete example</a></li></ul></li><li><a href=#final-words aria-label="Final words">Final words</a></li></ul></div></details></div><div class=post-content><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>While reasoning is important, readers may not be interested in all the frustrations I experienced while figuring out how to get things done. If you&rsquo;re looking for a quick solution, skip to the <a href=#what-eventually-worked>&ldquo;What eventually worked?&rdquo;</a>
section. However, if you&rsquo;re interested in the thought process behind the solution, keep reading.</p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>Some might bother why the hell I&rsquo;d like to make my life so hard? &#x1f923;</p><p>We used to use <a href=https://github.com/ekalinin/nodeenv target=_blank><code>nodeenv</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>for that purpose. It provides a simple script that allows to fetch any version of Node. You have to configure <code>PATH</code> variable and you&rsquo;re done. It&rsquo;s very simple from the perspective of Docker images operator. There&rsquo;s one problem with <code>nodeenv</code> comparing it to the <code>nvm</code> - popularity.</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>nodeenv</code></td><td><img alt="GitHub Repo stars" loading=lazy src="https://img.shields.io/github/stars/ekalinin/nodeenv?style=social"></td></tr><tr><td><code>nvm</code></td><td><img alt="GitHub Repo stars" loading=lazy src="https://img.shields.io/github/stars/nvm-sh/nvm?style=social"></td></tr></tbody></table><p>I was explaining to a lot of people, how to use <code>nodeenv</code>. No one knew it! But many of them knew <code>nvm</code> and were asking: <em>Why can&rsquo;t I just install version of Node that my project needs with NVM?</em> That&rsquo;s how I started thinking about better ways to deal with Node version management.</p><p>I&rsquo;m supporting organization with thousands of projects. Node projects can be counted in hundreds. It&rsquo;s not possible to provide up to date base images for all the Node versions that people would request. But I can <strong>provide a base</strong>, which would <strong>allow to install any Node version</strong> you need on up to date base images. That&rsquo;s what this article is about.</p><h2 id=nvm-is-nice-and-simple-how-hard-it-might-be-to-get-it-working-with-cicd>NVM is nice and simple, how hard it might be to get it working with CI/CD?<a hidden class=anchor aria-hidden=true href=#nvm-is-nice-and-simple-how-hard-it-might-be-to-get-it-working-with-cicd>#</a></h2><p>Over the past few days, I&rsquo;ve been working on providing <a href=https://github.com/nvm-sh/nvm target=_blank><code>nvm</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>for both my company&rsquo;s Docker base images and for CI/CD. However, it hasn&rsquo;t been an easy task.</p><p>In general, <code>nvm</code> (know as Node Version Manager) is loved by frontend developers because it allows them to drop a <code>.nvmrc</code> file in their project, and each time they switch between projects, everything works seamlessly. <code>nvm</code> is responsible for installing (or activating) the version of Node required by a specific project. A similar functionality is provided by <a href=https://github.com/ekalinin/nodeenv target=_blank><code>nodeenv</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>, which is Python-based and based on <a href=https://github.com/pypa/virtualenv target=_blank><code>virtualenv</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>.</p><p>While setting up <code>nodeenv</code> is straightforward because it&rsquo;s a regular CLI command, <code>nvm</code> is not. When you follow nvm&rsquo;s installation instructions<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, you end up with something like the following code in one of the startup files (<code>~/.bashrc</code>, <code>~/.profile</code>, or <code>~/.zshrc</code>):</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Typical nvm installation in ~/.bashrc</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export NVM_DIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$HOME<span style=color:#e6db74>/.nvm&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/bash_completion&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/bash_completion&#34;</span>
</span></span></code></pre></div></div></div><br><p>Installing <code>nvm</code> involves &ldquo;sourcing&rdquo; (that&rsquo;s what <code>.</code> do) <code>nvm.sh</code> with some shell functions into your current shell. This is not a big deal for your local machine, but it becomes an issue if you want to use <code>nvm</code> in non-interactive shells for your CI/CD.</p><p>Let&rsquo;s take <code>bash</code> as an example. Suddenly, it becomes important to know which file you&rsquo;ve put the <code>nvm</code> lines in because not all of them are loaded for non-interactive shells<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. The startup files for bash (in order) are:</p><ul><li>Interactive (called with <code>--login</code>)<ul><li><code>/etc/profile</code></li><li><code>~/.bash_profile</code></li><li><code>~/.bash_login</code></li><li><code>~/.profile</code></li></ul></li><li>Non-interactive<ul><li><code>~/.bashrc</code></li></ul></li></ul><p>It&rsquo;s worth noting that <code>~/.profile</code> usually loads <code>~/.bashrc</code> automatically (check yours). But what about <code>sh</code>, <code>dash</code> or <code>zsh</code>? If you&rsquo;re calling <code>nvm</code> on Jenkins, what shell will it call? These varieties of combinations make it incredibly hard to make <code>nvm</code> behave consistently.</p><p>To better understand my use case, I use:</p><ul><li><a href=https://www.jenkins.io/ target=_blank>Jenkins<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>for CI/CD</li><li>Which runs as a Docker container on a K8S cluster</li><li>The container contains most of the tools needed by developers (but just single LTS version of Node).</li></ul><h3 id=getting-it-working-in-the-dockerfile>Getting it working in the Dockerfile<a hidden class=anchor aria-hidden=true href=#getting-it-working-in-the-dockerfile>#</a></h3><p>I eventually found a nice way to make <code>nvm</code> work in a Dockerfile - by using the <a href=https://docs.docker.com/engine/reference/builder/#shell target=_blank><code>SHELL</code> directive<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>. By default, it&rsquo;s set to: <code>["/bin/sh", "-c"]</code>.</p><p>This shell does not load the files we need and starts a non-interactive shell. We can fix it with:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Enforcing interactive shell in the Dockerfile</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;/usr/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;--login&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br><p>The whole Dockerfile might look like this:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Example Dockerfile</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>ubuntu:22.04</span> <span style=color:#66d9ef>as</span> <span style=color:#e6db74>fetcher</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> NVM_VERSION v0.39.3<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y git <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git clone <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --depth <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --branch $NVM_VERSION <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        https://github.com/nvm-sh/nvm.git<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>ubuntu:22.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># we don&#39;t want to store cached files in the image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>VOLUME</span> <span style=color:#e6db74>/var/cache/apt</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># prerequisites</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get install -y curl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>SHELL</span> [<span style=color:#e6db74>&#34;/bin/bash&#34;</span>, <span style=color:#e6db74>&#34;--login&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> NVM_DIR<span style=color:#f92672>=</span>/opt/nvm<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># copy the nvm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>fetcher nvm $NVM_DIR<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># change ownership if needed</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chown -R <span style=color:#66d9ef>$(</span>id -un<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -gn<span style=color:#66d9ef>)</span> $NVM_DIR <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    echo <span style=color:#e6db74>&#39;[ -s &#34;$NVM_DIR/nvm.sh&#34; ] &amp;&amp; . &#34;$NVM_DIR/nvm.sh&#34; --no-use&#39;</span> &gt;&gt; ~/.profile<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br></p><p>What happen here?</p><ol><li><p>A shallow clone of the <code>nvm</code> repository is performed with <code>git</code> and it&rsquo;s pinned to a specific version.</p></li><li><p>The final image requires some dependencies such as <code>bash</code> and <code>curl</code>.</p></li><li><p>The <code>SHELL</code> is set to pretend interactive.</p></li><li><p>The <code>nvm</code> files are copied to <code>/opt/nvm</code>.</p></li><li><p><code>chown</code> is used to set the ownership of the files.</p></li><li><p>The steps in the installation guide<sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> are followed with some exceptions such as setting the <code>NVM_DIR</code> environment variable directly in the Dockerfile, and skipping bash completion.</p></li><li><p>The sourcing of <code>nvm.sh</code> is followed by <code>--no-use</code> to lazily load <code>nvm</code> so that it&rsquo;s not loaded until it&rsquo;s used<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p></li></ol><p>Lastly, you can test if it&rsquo;s working by adding some commands at the end of the Dockerfile to check the <code>nvm</code> version, install different versions of Node, and check their versions as well.</p><h3 id=getting-it-working-in-jenkins>Getting it working in Jenkins<a hidden class=anchor aria-hidden=true href=#getting-it-working-in-jenkins>#</a></h3><p>The pattern of running Jenkins agents as containers is great for packing development tools into Docker images and running them when needed. However, it can be challenging to get <code>nvm.sh</code> sourced properly when Jenkins agents are started as containers.</p><p>Now that we have a working <code>nvm</code> in Docker image, we can use it in Jenkins. The easiest way is to use the Docker image we created above, as a base for a custom Jenkins agent image which includes <code>nvm</code> and all the necessary Node versions.</p><p>Example Dockerfile:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Jenkins agent Dockerfile</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>our-company/our-nvm-base:latest</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># you might need to create jenkins user earlier</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>USER</span> <span style=color:#e6db74>jenkins</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> NODE_VERSIONS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;lts/* 16&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># install Node versions</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> nvm install $NODE_VERSIONS <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    nvm use <span style=color:#e6db74>&#34;lts/*&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    npm install -g yarn<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br><p>And that&rsquo;s it! Right? &#x1f914;</p><h3 id=was-it-enough-to-get-it-working>Was it enough to get it working?<a hidden class=anchor aria-hidden=true href=#was-it-enough-to-get-it-working>#</a></h3><p>Not really &#x1f615;. Why?</p><p>It all depends how do you call the commands. While it works well during the build time, it may not work when running the container or calling commands in different ways.</p><p>For example, it may not work if you use <code>docker exec</code> to run commands in containers - which we do when we test Docker base images. Similar situation happen when <code>sh</code> commands are used in Jenkins pipelines, <code>~/.profile</code> is not loaded, and so <code>nvm.sh</code> is not sourced properly. While it&rsquo;s possible to teach users to source <code>nvm.sh</code> in every <code>sh</code> command, this can be cumbersome and error-prone. Therefore, we need a better solution.</p><h2 id=what-eventually-worked>What eventually worked?<a hidden class=anchor aria-hidden=true href=#what-eventually-worked>#</a></h2><p>After struggling with the previous approach, I started thinking of an easier and more straightforward way to work with <code>nvm</code> and avoid common mistakes. I wanted something that would work the same way on both my local machine and in the CI/CD environment.</p><p>I realized that there were two main things that <code>nvm</code> did: managing installations of different Node versions and loading them on demand by modifying the <code>PATH</code> environment variable.</p><p>While thinking about how to simplify this process, it occurred to me that it would be much easier if <code>nvm</code> was a command rather than a <code>bash</code> function. And then, it hit me ‚Äì why not make <code>nvm</code> a command?</p><p>To do this, I created a file with the following code:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>First try on nvm wrapper</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># load nvm</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># call nvm with all the parameters</span>
</span></span><span style=display:flex><span>nvm $@
</span></span></code></pre></div></div></div><br></p><p>Next, I made this file executable and available for execution by writing it to <code>/usr/local/bin/nvm</code>, <code>~/.bin/nvm</code>, or <code>~/.local/bin/nvm</code> - whatever works for you.</p><p>With this solution, there was no longer any need to source <code>nvm.sh</code> so we could use <code>nvm</code>. Instead, it could be called directly as a command, which simplified and streamlined the process considerably.</p><p>I was able to install and manage different versions of Node. However, attempting to use <code>node</code> or <code>npm</code> commands resulted in an error message stating that the command was not recognized. This is because <code>nvm</code> installed like that do not mangle the <code>PATH</code> environment variable anymore. To fix this issue, there are two potential solutions.</p><p>The first solution involves manually setting the <code>PATH</code> variable to include the desired version of Node. If you only need one specific version in your Docker image, this solution might suffice. Additionally, exposing the <code>bin</code> directory will automatically expose all custom binaries installed with <code>npm</code>.</p><p>It&rsquo;s as easy as adding in Dockerfile of agent:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>ENV</span> PATH<span style=color:#f92672>=</span>$NVM_DIR/versions/node/v18.16.0/bin:$PATH<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>The second solution involves creating wrappers for <code>node</code> and <code>npm</code> commands in the same style as the <code>nvm</code> command. While this approach has the downside of not automatically exposing binaries installed via <code>npm</code>, it is a great idea overall. By running <code>node</code> wrapper, we can guess which version of Node should be used by sourcing <code>nvm</code> and running it.</p><p>Here are examples of the wrapper scripts for <code>node</code> and <code>npm</code>:</p><p>Wrapper script for <code>node</code>:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Node wrapper</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec node $@
</span></span></code></pre></div></div></div><br></p><p>Wrapper script for <code>npm</code>:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>NPM wrapper</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec npm $@
</span></span></code></pre></div></div></div><br></p><p>I use <code>exec</code> here for <code>node</code> and <code>npm</code> but not for <code>nvm</code> because <code>nvm</code> is a function while <code>node</code> and <code>npm</code> are executables. By using <code>exec</code> to run them, we eliminate one layer of <code>bash</code> shell, which saves a few megabytes of RAM in the container.</p><h3 id=how-to-automatically-expose-binaries-installed-by-npm>How to automatically expose binaries installed by npm?<a hidden class=anchor aria-hidden=true href=#how-to-automatically-expose-binaries-installed-by-npm>#</a></h3><p>The &ldquo;wrappers&rdquo; approach has a downside: binaries installed via <code>npm</code> are not immediately available. They have to be wrapped or linked, or the <code>PATH</code> has to be modified. But we can automate this in our script!</p><p>Here&rsquo;s an improved version of <code>/usr/local/bin/npm</code>:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Improved /usr/local/bin/npm</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>npm $@
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;install&#34;</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  find <span style=color:#66d9ef>$(</span>dirname <span style=color:#66d9ef>$(</span>nvm which node<span style=color:#66d9ef>))</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -executable <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#ae81ff>\(</span> -type f -o -type l <span style=color:#ae81ff>\)</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -print <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | sed <span style=color:#e6db74>&#39;/node$/d;/npm$/d&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  | xargs -I<span style=color:#f92672>{}</span> ln -sf <span style=color:#f92672>{}</span> /usr/local/bin/
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span></code></pre></div></div></div><br><p>This script works by first executing <code>npm $@</code> normally, without <code>exec</code>. After successful execution of <code>npm install</code>, it will find all the executables in the same directory as the current <code>node</code> executable, except for <code>node</code> and <code>npm</code> themselves, and symlink them to a directory already in the <code>PATH</code>, such as <code>/usr/local/bin</code>. Note that using <code>/usr/local/bin</code> will require root permissions. Alternatively, you can use <code>~/bin</code> or <code>~/.local/bin</code>, as long as one of these directories is in the <code>PATH</code>.</p><h3 id=what-about-npx>What about <code>npx</code>?<a hidden class=anchor aria-hidden=true href=#what-about-npx>#</a></h3><p>A colleague suggest me, that <code>npx</code> command should be wrapped too. I used same script as for <code>npm</code> but without linking after install. Final script will look like:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Example /usr/local/bin/npx</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>[</span> -s <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> . <span style=color:#e6db74>&#34;</span>$NVM_DIR<span style=color:#e6db74>/nvm.sh&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec npx $@
</span></span></code></pre></div></div></div><br><h3 id=complete-example>Complete example<a hidden class=anchor aria-hidden=true href=#complete-example>#</a></h3><p>I prepared <a href=https://github.com/tgagor/docker-nvm-example target=_blank>example repo with Dockerfiles<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>implementing both ways + some test proving why solution with wrappers works better<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>This example presents a base image, which provides just NVM a top Ubuntu, without any version of Node available out of the box. You can use this base in a Docker image:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>How to use it in the real app</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>tgagor/base-v2/nvm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># copy sources</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./src ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> .nvmrc ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># install Node you need, set it as default, upgrade npm to latest version</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> nvm install --default --latest-npm<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># install your app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install ...<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br><p>Use those wrapper scripts in your CI/CD agents and you will be able to use NVM in the same way.</p><h2 id=final-words>Final words<a hidden class=anchor aria-hidden=true href=#final-words>#</a></h2><p>In conclusion, managing multiple versions of Node can be a hassle, but by creating a simple wrapper script, we can make <code>nvm</code> a command and automate the process of exposing the correct binaries installed via <code>npm</code>. With these techniques, we can easily manage multiple Node versions and ensure that our development and CI/CD environments will work in the same way.</p><p>Hopefully, this article has provided some useful insights and tips for managing Node versions with <code>nvm</code>. Happy coding!</p><p>What&rsquo;s pretty interesting, I review a huge part of Internet looking for solutions like this and no one does it like me. Am I wrong? Are there better ways to achieve it?</p><hr><p>Enjoyed?
<a class=kofi href=https://ko-fi.com/tgagor target=_blank><img height=36 style=border:0;height:36px src='https://storage.ko-fi.com/cdn/kofi5.png?v=3' border=0 alt='Buy Me a Coffee at ko-fi.com'></a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/nvm-sh/nvm#git-install target=_blank>https://github.com/nvm-sh/nvm#git-install<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.gnu.org/software/bash/manual/html_node/Bash-Startup-Files.html target=_blank>https://www.gnu.org/software/bash/manual/html_node/Bash-Startup-Files.html<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://github.com/nvm-sh/nvm#additional-notes target=_blank>https://github.com/nvm-sh/nvm#additional-notes<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://github.com/tgagor/docker-nvm-example target=_blank>https://github.com/tgagor/docker-nvm-example<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://gagor.pro/tag/linux/>Linux</a></li><li><a href=https://gagor.pro/tag/bash/>Bash</a></li><li><a href=https://gagor.pro/tag/docker/>Docker</a></li><li><a href=https://gagor.pro/tag/devops/>DevOps</a></li><li><a href=https://gagor.pro/tag/best-practices/>Best Practices</a></li></ul><nav class=paginav><a class=prev href=https://gagor.pro/2023/12/use-github-with-ssh-on-port-443/><span class=title>¬´ Prev</span><br><span>Use Github with SSH on port 443</span>
</a><a class=next href=https://gagor.pro/2023/03/change-configuration-of-docker-daemon-in-rancher-desktop/><span class=title>Next ¬ª</span><br><span>Change configuration of Docker daemon in Rancher Desktop</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on x" href="https://x.com/intent/tweet/?text=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems&amp;url=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f&amp;hashtags=Linux%2cbash%2cDocker%2cDevOps%2cBestpractices"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f&amp;title=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems&amp;summary=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems&amp;source=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f&title=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on whatsapp" href="https://api.whatsapp.com/send?text=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems%20-%20https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on telegram" href="https://telegram.me/share/url?text=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems&amp;url=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The best way to get NVM working in CI/CD systems on ycombinator" href="https://news.ycombinator.com/submitlink?t=The%20best%20way%20to%20get%20NVM%20working%20in%20CI%2fCD%20systems&u=https%3a%2f%2fgagor.pro%2f2023%2f04%2fthe-best-way-to-get-nvm-working-in-ci-cd-systems%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=tgagor/tgagor.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg4MDg1Mw==" data-category=Announcements data-category-id=DIC_kwDOAmCIlc4CcAtN data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=transparent_dark data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span><a href=https://gagor.pro/>Tom's Blog</a> &copy; 2008-2025</span>
<span>Content licensed under <a rel="license noopener noreferrer" target=_blank href=https://creativecommons.org/licenses/by-sa/4.0/>(CC BY-SA 4.0)</a></span></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "8d51d5292abd4c77bad90db038659671"}'></script><script defer src=https://analytics.ahrefs.com/analytics.js data-key=ngiuUolR4+T0MnN5eV7I/A async></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>