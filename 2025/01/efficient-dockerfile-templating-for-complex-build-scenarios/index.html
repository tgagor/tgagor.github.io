<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Efficient Dockerfile templating for complex build scenarios | Tom's Blog</title><meta name=keywords content="Best practices,DevOps,Docker,Linux"><meta name=description content="Why even consider templating Dockerfiles? Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, whi"><meta name=author content="Tom"><link rel=canonical href=https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/><link crossorigin=anonymous href=/assets/css/stylesheet.dd9b399756d51cbc22dd492f8bc5e6baa73d268548ef7584ed5740fe95fdcbce.css integrity="sha256-3Zs5l1bVHLwi3Ukvi8Xmuqc9JoVI73WE7VdA/pX9y84=" rel="preload stylesheet" as=style><link rel=icon href=https://gagor.pro/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gagor.pro/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gagor.pro/favicon-32x32.png><link rel=apple-touch-icon href=https://gagor.pro/apple-touch-icon.png><link rel=mask-icon href=https://gagor.pro/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta name=fediverse:creator content="@tgagor@mastodon.social"><link rel=me href=https://mastodon.social/@tgagor><meta property="og:url" content="https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/"><meta property="og:site_name" content="Tom's Blog"><meta property="og:title" content="Efficient Dockerfile templating for complex build scenarios"><meta property="og:description" content="Why even consider templating Dockerfiles? Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, which is automatically cached. This process integrates well with SCM, where you ‚Äúcommit‚Äù the results of one stage and move forward with other changes. The process can be easily parameterized with ARG instructions, similar to ENV but provided during the build. This allows for creating highly flexible builds. For most users, this is more than sufficient. However, there‚Äôs a notable exception: Docker base images."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-01T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-16T11:12:25+01:00"><meta property="article:tag" content="Best Practices"><meta property="article:tag" content="DevOps"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Linux"><meta property="og:image" content="https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover.webp"><meta name=twitter:title content="Efficient Dockerfile templating for complex build scenarios"><meta name=twitter:description content="Why even consider templating Dockerfiles?
Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, which is automatically cached. This process integrates well with SCM, where you &ldquo;commit&rdquo; the results of one stage and move forward with other changes. The process can be easily parameterized with ARG instructions, similar to ENV but provided during the build. This allows for creating highly flexible builds. For most users, this is more than sufficient. However, there&rsquo;s a notable exception: Docker base images."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gagor.pro/posts/"},{"@type":"ListItem","position":2,"name":"Efficient Dockerfile templating for complex build scenarios","item":"https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Efficient Dockerfile templating for complex build scenarios","name":"Efficient Dockerfile templating for complex build scenarios","description":"Why even consider templating Dockerfiles? Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, which is automatically cached. This process integrates well with SCM, where you \u0026ldquo;commit\u0026rdquo; the results of one stage and move forward with other changes. The process can be easily parameterized with ARG instructions, similar to ENV but provided during the build. This allows for creating highly flexible builds. For most users, this is more than sufficient. However, there\u0026rsquo;s a notable exception: Docker base images.\n","keywords":["Best practices","DevOps","Docker","Linux"],"articleBody":"Why even consider templating Dockerfiles? Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, which is automatically cached. This process integrates well with SCM, where you ‚Äúcommit‚Äù the results of one stage and move forward with other changes. The process can be easily parameterized with ARG instructions, similar to ENV but provided during the build. This allows for creating highly flexible builds. For most users, this is more than sufficient. However, there‚Äôs a notable exception: Docker base images.\nWhether you‚Äôre working on public base images or preparing bases for your enterprise, they differ from typical app images. App images rely on bases to deploy your single app with consistent quality, stable builds, and no surprises from breaking changes in the base images. Typically, you select the runtime version you need, for example, Tomcat 10.1.34, and then use the Docker image tomcat:10.1.34-jdk21. If you‚Äôre brave, you might choose tomcat:10.1-jdk21, which provides some Tomcat upgrades, or even tomcat:10-jdk21. Currently, Tomcat supports three major versions: 9, 10, and 11. Your apps might use any of them and they all have to be provided with stable and secure dependencies. Check Docker Hub page for the Tomcat image‚Äâexternal link to see how many of tags they have to provide for people‚Äôs convenience.\nFrom the perspective of someone responsible for base images, how can you support this? Tomcat upgrades are owned by development teams because they might need to upgrade dependent libraries or configurations. But maintaining a stable and patched base image is usually the responsibility of an infra/SRE team. Keeping ‚Äúthe platform‚Äù patched and stable might require updating OS packages in images, even if developers don‚Äôt pay attention to that process. If the Dev team stays on an older version of Tomcat, that‚Äôs their risk, but if you keep images with unpatched openssl, it becomes ‚Äúa platform problem‚Äù. Directives like NIS21 make enterprises accountable for not keeping the application stack updated, but upgrades of Docker images are tricky because you might need to support:\nDifferent OS, like Ubuntu and Alpine, Different Tomcat versions, Different Java versions, Configuration differences, Different package names, etc. Let‚Äôs say you support 2 different Ubuntu versions + 1 Alpine, up to 3 versions of Tomcat on 3 LTS versions of Java, resulting in (2+1)*3*3 -\u003e 27 combinations. Supporting up to 5 versions of Tomcat results in 45 combinations. It‚Äôs growing exponentially!\ngraph LR A(tomcat) --\u003e T9(9) T9 --\u003e J11(Java 11) T9 --\u003e J17(Java 17) T9 --\u003e J21(Java 21) J11 --\u003e U1(Ubuntu 24.04) J11 --\u003e U2(Ubuntu 22.04) J11 --\u003e A1(Alpine 3.21) J17 --\u003e U1 J17 --\u003e U2 J17 --\u003e A1 J21 --\u003e U1 J21 --\u003e U2 J21 --\u003e A1 A --\u003e T10(10) T10 --\u003e J11(Java 11) T10 --\u003e J17(Java 17) T10 --\u003e J21(Java 21) A --\u003e T11(11) T11 --\u003e J11(Java 11) T11 --\u003e J17(Java 17) T11 --\u003e J21(Java 21) In a large enterprise, you‚Äôre not only working with Tomcat. There will be various Java versions, some legacy but still required for old systems. And more: JBoss, multiple Python versions, Apache or Nginx, Redis, NoSQL DBs, PostgreSQL from version 10 to 16. All requiring support on 2-3 different operating systems. The number of combinations is overwhelming!\nSome questions should already arise in your head‚Ä¶\nHow can We do it better? In organizations big enough, you need a central process to manage upgrades. You need to prove that you at least tried to keep everything updated. That‚Äôs why it might make sense to manage your own base images, which you can control and manage security upgrades at your own pace, with known rules in the organization . We know what we have to do, but how to do it?\nStandard tools provide a lot of convenience to parameterize builds, so you might start wrapping some shell scripts to use them. At some point, you will realize that without parallel builds, it would take hours to finish, so you make your scripts even more complicated. I used Makefiles for that . Then you will face small differences between tools or OS versions - sometimes it‚Äôs a package name, other times it‚Äôs a file location. You have to keep those differences somewhere and start adding more directories, copying files back and forth, making it easy to make a typo or mistake. Just take a look at official Corretto images‚Äâexternal link - there are directories, with sub-directories, with sub‚Ä¶ To manage all the quirks.\nThat‚Äôs when you start thinking:\nIf I could just template this and that, I‚Äôd have just two files and the rest could be autogenerated.\nBut building such a templating system is not easy, and that‚Äôs where I reached too. I needed a tool that would allow me to easily declare what I want to build, and then execute it simply. I want to make the whole tagging process easy, and I use labels on images too, so I wanted them supported as well.\nI found this one article‚Äâexternal link but I wasn‚Äôt happy with the tool. It was too complicated and gluing things together felt odd. I knew I could do better.\nMy idea was inspired by Ansible playbooks. Simple YAML, easy to write, easy to read and understand, with structure that describe itself. Ansible relies on Jinja22 and as I started writing my tool in Python, I used it too. But most of my friends, including myself, got used to GoLang templates - used for Helm charts templating and widely around Docker tools. I decided it‚Äôs time to learn GoLang (how hard could it be, right?) and switch templating language. That‚Äôs how template-dockerfiles‚Äâexternal link (or td‚Äâexternal link in short) tool started: .\nKey features:\nSimple YAML config defining what to build and how. Dockerfiles templating when needed (GoLang templates + Sprig functions3). Tags or versions templated the same way. Labels (I use OCI Label Schema heavily) templated the same way. Easy parallel builds when possible. Easy to integrate with CI/CD, allowing to just generate templates or build and push completely - whatever you prefer. Why templating is better? At some scale, copying and pasting files and scripts, despite being a simple task, can be error-prone due to the number of changes you have to perform. This increases the probability of mistakes or typos. I‚Äôve made mistakes like that, they passed review by my teammates and went to production because there were just a lot of similar changes and it was hard to spot one outlier.\nWorking with templates has the benefit that you define a general rule by which templates will be generated. Over time, you might add a few exceptions or additional steps required for specific versions. When you generate images from templates, they follow the rules strictly, and if you make a small mistake in the definition, it will propagate to multiple images, causing a blast impact. We can say that either you succeed or fail spectacularly ü§£\nWorking with templates is more like coding. It requires a higher level of focus and by that, it‚Äôs less prone to making a mistake that would apply to just one version. On the other hand, copying and pasting the same change across multiple files or directories is a dumb task, which we‚Äôre doing on auto-pilot, and it‚Äôs much easier to make a silly mistake.\nEnough talking about the reasons. Let me go through some examples.\nTemplating Dockerfiles Examples In general, my tool requires:\nConfiguration file. Bunch of Docker files. You can structure them as you want as long as the configuration is aligned with your directory structure.\nExample 1: Simple Configuration, no templating Let start with something simple, like preparing a generic base image. You save this in your build.yaml file (or whatever you would provide to --config flag).\nDefine your config file: build.yaml images: base: dockerfile: base/Dockerfile variables: alpine: - \"3.18\" - \"3.19\" - \"3.20\" args: BASEIMAGE: alpine:{{ .alpine }} tags: - base:{{ .tag }}-alpine{{ .alpine }} - base:{{ .tag }}-alpine{{ .alpine | splitList \".\" | first }} - base:alpine{{ .alpine | splitList \".\" | first }} - base:{{ .tag }} Fields Description images: The root key for defining different images. base: The name of the image. Name it as dockerfile: The path to the Dockerfile or Dockerfile template (.tpl extension). variables: Variables to be used in the template. alpine: A variable which represents list of Alpine versions. args: Arguments that will be passed as --build-arg, during the image build. tags: The tags to be applied to the generated images, plus templated values. {{ .tag }} : Is a value provided to --tag parameter, usually a version of your image. Let choose really basic, base image: base/Dockerfile ARG BASEIMAGE FROM ${BASEIMAGE} CMD [\"echo\"] Assuming you already installed the tool‚Äâexternal link , let generate templates by calling:\nBuild images td --config build.yaml --tag 1.0.0 --build It‚Äôs a simple config file but there‚Äôs already a lot happening there. It will produce 5 Docker images, one per each Alpine version and will tag them according to the rules. Thanks to that we already have multiple patterns, from which your developers can choose\nBuilt images $ docker image ls REPOSITORY TAG IMAGE ID CREATED SIZE base 1.0.0 bb5fa559eff4 3 months ago 12.1MB base 1.0.0-alpine3 bb5fa559eff4 3 months ago 12.1MB base 1.0.0-alpine3.20 bb5fa559eff4 3 months ago 12.1MB base 1.0.0-alpine3.19 5e664aff1066 3 months ago 11.5MB base 1.0.0-alpine3.18 87b441f4c072 3 months ago 11.5MB If you would like to introduce just released Alpine 3.21‚Äâexternal link , it‚Äôs just one line more in the config file.\nExample 2: Simple configuration with templating We went through simplest example, so it‚Äôs time to rise the bar. We will use Dockerfile.tpl now and we don‚Äôt need args anymore. We will also introduce Alpine 3.21, which for some reason would require to do something differently than other versions. We will also add one more tag, to simplify referring to specific Alpine‚Äôs version. Final config will be:\nDefine your config file: build.yaml images: base: dockerfile: base/Dockerfile.tpl variables: alpine: - \"3.18\" - \"3.19\" - \"3.20\" - \"3.21\" tags: - base:{{ .tag }}-alpine{{ .alpine }} - base:alpine{{ .alpine }} - base:{{ .tag }}-alpine{{ .alpine | splitList \".\" | first }} - base:alpine{{ .alpine | splitList \".\" | first }} - base:{{ .tag }} Our template is just slightly different as it have to ‚Äúreact‚Äù to this ‚Äúbreaking change‚Äù in Alpine 3.21. It would be easy to use bash conditions to react to different Alpine version in RUN directives, but it‚Äôs not easy to do the same for CMD - at least, not without custom entrypoint. As Go-Lang templates, provide us conditions and loops, we can do really crazy things in those templates, but please - don‚Äôt üòâ.\nbase/Dockerfile.tpl FROM alpine:{{ .alpine }} {{ if eq .alpine \"3.21\" }} CMD echo this is alpine 3.21 specific {{ else }} CMD echo this is generic {{ end }} Build command stays the same, but we will bump a minor version4: Build images td --config build.yaml --tag 1.1.0 --build And the result will be:\nResult images $ docker image ls REPOSITORY TAG IMAGE ID CREATED SIZE base alpine3.18 c46557602bb4 30 minutes ago 11.5MB base v1.1.0-alpine3.18 c46557602bb4 30 minutes ago 11.5MB base alpine3.19 ecc2bc3541fe 30 minutes ago 11.5MB base v1.1.0-alpine3.19 ecc2bc3541fe 30 minutes ago 11.5MB base alpine3.20 0319369f1076 30 minutes ago 12.1MB base v1.1.0-alpine3.20 0319369f1076 30 minutes ago 12.1MB base alpine3 9d78f7b4ccac 30 minutes ago 12.2MB base alpine3.21 9d78f7b4ccac 30 minutes ago 12.2MB base v1.1.0 9d78f7b4ccac 30 minutes ago 12.2MB base v1.1.0-alpine3 9d78f7b4ccac 30 minutes ago 12.2MB base v1.1.0-alpine3.21 9d78f7b4ccac 30 minutes ago 12.2MB Let test the result:\n~/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/ $ docker run -ti --rm base:alpine3.18 this is generic $ docker run -ti --rm base:alpine3.21 this is alpine 3.21 specific Let check again what happen here. With quite the same configuration and a template of Dockerfile we‚Äôve been able to generate 4 different images (1 per Alpine‚Äôs version), with 11 tags just to make the choice for people easier. Tags are generated in order, and variable‚Äôs values are also ordered so latest version of Alpine (listed as last one) is the new default.\nIt‚Äôs really clean and easy to follow, what happens here, which would be even more important in the next example üòâ\nExample 3: Complex Configuration I used Tomcat as an example earlier and this will be our next example. I know, that there are ready to use images, but it‚Äôs just a good, complex enough example üòÑ\nExample config file: tomcat.yaml registry: repo.local prefix: base maintainer: Tomasz GƒÖgor labels: org.opencontainers.image.vendor: My Corp org.opencontainers.image.licenses: GPL-3.0-only org.opencontainers.image.url: https://my.url org.opencontainers.image.documentation: https://my.url/docs org.opencontainers.image.title: My Corp's Docker base images org.opencontainers.image.description: | This is a longer description of what this image is capable of. You might be setting your own timezone or preferred language settings and explain it nicely here. Some labels will be added by the tool automatically too. images: base: dockerfile: base/Dockerfile variables: alpine: - \"3.20\" - \"3.21\" args: BASEIMAGE: alpine:{{ .alpine }} tags: - base:{{ .tag }}-alpine{{ .alpine }} - base:alpine{{ .alpine }} - base:{{ .tag }}-alpine{{ .alpine | splitList \".\" | first }} - base:alpine{{ .alpine | splitList \".\" | first }} - base:{{ .tag }} - base:latest jdk: dockerfile: jdk/Dockerfile variables: alpine: - \"3.20\" - \"3.21\" java: - 11 - 17 - 21 args: BASEIMAGE: openjdk:{{ .java }}-jdk-alpine{{ .alpine }} tags: - jdk:{{ .tag }}-{{ .java }}-jdk-alpine{{ .alpine }} - jdk:{{ .tag }}-{{ .java }}-jdk-alpine{{ .alpine | splitList \".\" | first }} - jdk:{{ .java }}-jdk-alpine{{ .alpine | splitList \".\" | first }} - jdk:{{ .java }}-jdk - jdk:{{ .java }} - jdk:{{ .tag }} - jdk:latest jre: dockerfile: jre/Dockerfile variables: alpine: - \"3.20\" - \"3.21\" java: - 11 - 17 - 21 args: BASEIMAGE: {{ .registry }}/{{ .prefix }}/jdk:{{ .java }}-jdk-alpine{{ .alpine }} tags: - jre:{{ .tag }}-{{ .java }}-jre-alpine{{ .alpine }} - jre:{{ .tag }}-{{ .java }}-jre-alpine{{ .alpine | splitList \".\" | first }} - jre:{{ .java }}-jre-alpine{{ .alpine | splitList \".\" | first }} - jre:{{ .java }}-jre - jre:{{ .java }} - jre:{{ .tag }} - jre:latest tomcat: dockerfile: tomcat/Dockerfile.tpl variables: alpine: - \"3.20\" - \"3.21\" java: - 11 - 17 - 21 tomcat: - 9.0.98 - 10.1.34 - 11.0.2 excludes: # follow minimum required version # https://tomcat.apache.org/whichversion.html - tomcat: 11.0.2 java: 8 - tomcat: 11.0.2 java: 11 - tomcat: 10.1.34 java: 8 tags: - tomcat:{{ .tag }}-tomcat{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }} - tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }} - tomcat:{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }} - tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine | splitList \".\" | first }} - tomcat:{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine | splitList \".\" | first }} - tomcat:{{ .tag }}-{{ .tomcat | splitList \".\" | first }}-jdk{{ .java }}-alpine{{ .alpine | splitList \".\" | first }} - tomcat:{{ .tomcat | splitList \".\" | first }}-jdk{{ .java }}-alpine{{ .alpine | splitList \".\" | first }} - tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }} - tomcat:{{ .tomcat }}-jdk{{ .java }} - tomcat:{{ .tag }}-{{ .tomcat | splitList \".\" | first }}-jdk{{ .java }} - tomcat:{{ .tomcat | splitList \".\" | first }}-jdk{{ .java }} - tomcat:{{ .tag }}-{{ .tomcat }} - tomcat:{{ .tomcat }} - tomcat:{{ .tag }}-{{ .tomcat | splitList \".\" | first }} - tomcat:{{ .tomcat | splitList \".\" | first }} - tomcat:latest Fields Description registry: URL to our private registry. prefix: Add a base prefix to each image. maintainer: A contact team or person. labels: Bunch of OCI Label Schema‚Äâexternal link labels. excludes: Variants we don‚Äôt want to build. rest as in the simple example. I won‚Äôt be showing Dockerfiles here, as the main actor here is configuration. It would be extremely hard to follow such structure with all those variations with bash scripts or Makefiles. It‚Äôs around 100 lines of configuration, easy to read and understand that will produce tens of image variants, that can be used by your developers in a way they need. Templating abilities on tags, args or labels allow to dynamically describe our images.\nThat‚Äôs the final I wanted to achieve. Simple recipe to deliver complex build strategies for Docker images.\nMore Examples I will try to update and curate a list of good examples of td usage in the wild. For now, it‚Äôs mostly mine stuff:\nhttps://github.com/tgagor/docker-centos‚Äâexternal link Weekly updated CentOS Stream images. td for building, Github actions‚Äâexternal link for versioning, security scans. That‚Äôs really a simple example to start with.\nhttps://github.com/tgagor/template-dockerfiles/tree/main/example‚Äâexternal link Examples in the td repo‚Äâexternal link . They show how to build Corretto‚Äâexternal link images based on Alpine Linux in JDK and JRE variants.\nhttps://github.com/tgagor/docker-chisel‚Äâexternal link Cannonical released‚Äâexternal link interesting tool called Chisel‚Äâexternal link . It allows to ‚Äúcut‚Äù minimal versions of Docker images by extracting only binary dependencies required to run our app. It allows to compete with Alpine‚Äôs images on size, but with standard glibc.\nIt‚Äôs a complete, multi-platform build with Github actions for automatic builds!\nWhat more you can do? I plan to extend the capabilities of the tool to include:\nImage squashing for reducing the number of layers (--squash flag, already supported). Different compression options for even better size optimizations out of the box. As savings in the base images accumulate in all child images. Multi-platform builds support. Enjoyed? https://en.wikipedia.org/wiki/Cyber-security_regulation‚Äâexternal link ‚Ü©Ô∏é\nhttps://jinja.palletsprojects.com/en/stable/‚Äâexternal link ‚Ü©Ô∏é\nhttp://masterminds.github.io/sprig/‚Äâexternal link ‚Ü©Ô∏é\nhttps://semver.org/spec/v2.0.0.html‚Äâexternal link ‚Ü©Ô∏é\n","wordCount":"2882","inLanguage":"en","image":"https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover.webp","datePublished":"2025-01-01T00:00:00Z","dateModified":"2025-11-16T11:12:25+01:00","author":{"@type":"Person","name":"Tom"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/"},"publisher":{"@type":"Organization","name":"Tom's Blog","logo":{"@type":"ImageObject","url":"https://gagor.pro/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gagor.pro/ accesskey=h title="Tom's Blog (Alt + H)"><img src=https://gagor.pro/favicon-36x36.avif alt="Page logo" aria-label=logo height=36 width=36>Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gagor.pro/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://gagor.pro/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://gagor.pro/bookshelf/ title=Bookshelf><span>Bookshelf</span></a></li><li><a href=https://gagor.pro/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://gagor.pro/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gagor.pro/>Home</a>&nbsp;¬ª&nbsp;<a href=https://gagor.pro/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Efficient Dockerfile templating for complex build scenarios</h1><div class=post-meta><span title='2025-01-01 00:00:00 +0000 UTC'>2025-01-01</span>&nbsp;¬∑&nbsp;14 min&nbsp;¬∑&nbsp;Tom</div></header><figure class=entry-cover><img loading=eager srcset='https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover_hu_e970404488b8c115.webp 360w,https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover_hu_ebc538a466a12cd4.webp 480w,https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover_hu_aa986fad1793f240.webp 720w,https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover_hu_454056d8f399aee8.webp 1080w,https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover_hu_fa928b3f3c465e56.webp 1500w,https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover.webp 1500w' src=https://gagor.pro/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/images/cover.webp sizes="(min-width: 768px) 720px, 100vw" width=1500 height=625 alt="[Photo by Pixabay](https://www.pexels.com/photo/blue-white-orange-and-brown-container-van-163726/)"><figcaption><a href=https://www.pexels.com/photo/blue-white-orange-and-brown-container-van-163726/ target=_blank>Photo by Pixabay<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span></a></figcaption></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#why-even-consider-templating-dockerfiles aria-label="Why even consider templating Dockerfiles?">Why even consider templating Dockerfiles?</a></li><li><a href=#how-can-we-do-it-better aria-label="How can We do it better?">How can We do it better?</a></li><li><a href=#why-templating-is-better aria-label="Why templating is better?">Why templating is better?</a></li><li><a href=#templating-dockerfiles-examples aria-label="Templating Dockerfiles Examples">Templating Dockerfiles Examples</a><ul><li><a href=#example-1-simple-configuration-no-templating aria-label="Example 1: Simple Configuration, no templating">Example 1: Simple Configuration, no templating</a><ul><li><a href=#fields-description aria-label="Fields Description">Fields Description</a></li></ul></li><li><a href=#example-2-simple-configuration-with-templating aria-label="Example 2: Simple configuration with templating">Example 2: Simple configuration with templating</a></li><li><a href=#example-3-complex-configuration aria-label="Example 3: Complex Configuration">Example 3: Complex Configuration</a><ul><li><a href=#fields-description-1 aria-label="Fields Description">Fields Description</a></li></ul></li><li><a href=#more-examples aria-label="More Examples">More Examples</a></li></ul></li><li><a href=#what-more-you-can-do aria-label="What more you can do?">What more you can do?</a></li></ul></div></details></div><div class=post-content><h2 id=why-even-consider-templating-dockerfiles>Why even consider templating Dockerfiles?<a hidden class=anchor aria-hidden=true href=#why-even-consider-templating-dockerfiles>#</a></h2><p>Dockerfiles revolutionized the industry with their simplicity. Each instruction creates a new layer in the image, which is automatically cached. This process integrates well with SCM, where you &ldquo;commit&rdquo; the results of one stage and move forward with other changes. The process can be easily parameterized with <code>ARG</code> instructions, similar to <code>ENV</code> but provided during the build. This allows for creating highly flexible builds. For most users, this is more than sufficient. However, there&rsquo;s a notable exception: Docker base images.</p><p>Whether you&rsquo;re working on public base images or preparing bases for your enterprise, they differ from typical app images. App images rely on bases to deploy your single app with consistent quality, stable builds, and no surprises from breaking changes in the base images. Typically, you select the runtime version you need, for example, Tomcat 10.1.34, and then use the Docker image <code>tomcat:10.1.34-jdk21</code>. If you&rsquo;re brave, you might choose <code>tomcat:10.1-jdk21</code>, which provides some Tomcat upgrades, or even <code>tomcat:10-jdk21</code>. Currently, Tomcat supports three major versions: 9, 10, and 11. Your apps might use any of them and they all have to be provided with stable and secure dependencies. Check <a href=https://hub.docker.com/_/tomcat target=_blank>Docker Hub page for the Tomcat image<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>to see how many of tags they have to provide for people&rsquo;s convenience.</p><p>From the perspective of someone responsible for base images, how can you support this? Tomcat upgrades are owned by development teams because they might need to upgrade dependent libraries or configurations. But maintaining a stable and patched base image is usually the responsibility of an infra/SRE team. Keeping &ldquo;the platform&rdquo; patched and stable might require updating OS packages in images, even if developers don&rsquo;t pay attention to that process. If the Dev team stays on an older version of Tomcat, that&rsquo;s their risk, but if you keep images with unpatched <code>openssl</code>, it becomes &ldquo;a platform problem&rdquo;. Directives like NIS2<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> make enterprises accountable for not keeping the application stack updated, but upgrades of Docker images are tricky because you might need to support:</p><ul><li>Different OS, like Ubuntu and Alpine,</li><li>Different Tomcat versions,</li><li>Different Java versions,</li><li>Configuration differences,</li><li>Different package names, etc.</li></ul><p>Let&rsquo;s say you support 2 different Ubuntu versions + 1 Alpine, up to 3 versions of Tomcat on 3 LTS versions of Java, resulting in <code>(2+1)*3*3 -> 27</code> combinations. Supporting up to 5 versions of Tomcat results in 45 combinations. It&rsquo;s growing exponentially!</p><pre class=mermaid>graph LR
    A(tomcat) --> T9(9)
    T9 --> J11(Java 11)
    T9 --> J17(Java 17)
    T9 --> J21(Java 21)
    J11 --> U1(Ubuntu 24.04)
    J11 --> U2(Ubuntu 22.04)
    J11 --> A1(Alpine 3.21)
    J17 --> U1
    J17 --> U2
    J17 --> A1
    J21 --> U1
    J21 --> U2
    J21 --> A1
    A --> T10(10)
    T10 --> J11(Java 11)
    T10 --> J17(Java 17)
    T10 --> J21(Java 21)
    A --> T11(11)
    T11 --> J11(Java 11)
    T11 --> J17(Java 17)
    T11 --> J21(Java 21)
</pre><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'dark'
    });
  </script><p>In a large enterprise, you&rsquo;re not only working with Tomcat. There will be various Java versions, some legacy but still required for old systems. And more: JBoss, multiple Python versions, Apache or Nginx, Redis, NoSQL DBs, PostgreSQL from version 10 to 16. All requiring support on 2-3 different operating systems. The number of combinations is overwhelming!</p><p>Some questions should already arise in your head&mldr;</p><h2 id=how-can-we-do-it-better>How can We do it better?<a hidden class=anchor aria-hidden=true href=#how-can-we-do-it-better>#</a></h2><p>In organizations big enough, you need a central process to manage upgrades. You need to prove that you at least tried to keep everything updated. That&rsquo;s why it might make sense to manage your own base images, which you can control and manage security upgrades at your own pace, <a href=https://gagor.pro/2024/02/best-practices-for-patching-and-deprecating-docker-images/>with known rules in the organization</a>
. We know what we have to do, but how to do it?</p><p>Standard tools provide a lot of convenience to parameterize builds, so you might start wrapping some shell scripts to use them. At some point, you will realize that without parallel builds, it would take hours to finish, so you make your scripts even more complicated. <a href=https://gagor.pro/2024/02/how-i-stopped-worrying-and-loved-makefiles/>I used Makefiles for that</a>
. Then you will face small differences between tools or OS versions - sometimes it&rsquo;s a package name, other times it&rsquo;s a file location. You have to keep those differences somewhere and start adding more directories, copying files back and forth, making it easy to make a typo or mistake. Just take a look at <a href=https://github.com/corretto/corretto-docker/tree/a2a619f2ff274d58df109c775ae79acc7b8605a2 target=_blank>official Corretto images<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>- there are directories, with sub-directories, with sub&mldr; To manage all the quirks.</p><p>That&rsquo;s when you start thinking:</p><blockquote><p>If I could just template this and that, I&rsquo;d have just two files and the rest could be autogenerated.</p></blockquote><p>But building such a templating system is not easy, and that&rsquo;s where I reached too. I needed a tool that would allow me to easily declare what I want to build, and then execute it simply. I want to make the whole tagging process easy, and I use labels on images too, so I wanted them supported as well.</p><p>I found this <a href=https://medium.com/@bossm8/dockerfile-templating-made-easy-a261f9f2bd49 target=_blank>one article<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>but I wasn&rsquo;t happy with the tool. It was too complicated and gluing things together felt odd. I knew I could do better.</p><p>My idea was inspired by Ansible playbooks. Simple YAML, easy to write, easy to read and understand, with structure that describe itself. Ansible relies on Jinja2<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> and as I started writing my tool in Python, I used it too. But most of my friends, including myself, got used to GoLang templates - used for Helm charts templating and widely around Docker tools. I decided it&rsquo;s time to learn GoLang (how hard could it be, right?) and switch templating language. That&rsquo;s how <a href=https://github.com/tgagor/template-dockerfiles target=_blank><code>template-dockerfiles</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>(or <a href=https://github.com/tgagor/template-dockerfiles target=_blank><code>td</code><span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>in short) tool started: .</p><p>Key features:</p><ol><li>Simple YAML config defining what to build and how.</li><li>Dockerfiles templating when needed (GoLang templates + Sprig functions<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>).</li><li>Tags or versions templated the same way.</li><li>Labels (I use OCI Label Schema heavily) templated the same way.</li><li>Easy parallel builds when possible.</li><li>Easy to integrate with CI/CD, allowing to just generate templates or build and push completely - whatever you prefer.</li></ol><h2 id=why-templating-is-better>Why templating is better?<a hidden class=anchor aria-hidden=true href=#why-templating-is-better>#</a></h2><p>At some scale, copying and pasting files and scripts, despite being a simple task, can be error-prone due to the number of changes you have to perform. This increases the probability of mistakes or typos. I&rsquo;ve made mistakes like that, they passed review by my teammates and went to production because there were just a lot of similar changes and it was hard to spot one outlier.</p><p>Working with templates has the benefit that you define a general rule by which templates will be generated. Over time, you might add a few exceptions or additional steps required for specific versions. When you generate images from templates, they follow the rules strictly, and if you make a small mistake in the definition, it will propagate to multiple images, causing a blast impact. We can say that either you succeed or fail spectacularly &#x1f923;</p><p>Working with templates is more like coding. It requires a higher level of focus and by that, it&rsquo;s less prone to making a mistake that would apply to just one version. On the other hand, copying and pasting the same change across multiple files or directories is a dumb task, which we&rsquo;re doing on auto-pilot, and it&rsquo;s much easier to make a silly mistake.</p><p>Enough talking about the reasons. Let me go through some examples.</p><h2 id=templating-dockerfiles-examples>Templating Dockerfiles Examples<a hidden class=anchor aria-hidden=true href=#templating-dockerfiles-examples>#</a></h2><p>In general, my tool requires:</p><ol><li>Configuration file.</li><li>Bunch of Docker files.</li></ol><p>You can structure them as you want as long as the configuration is aligned with your directory structure.</p><h3 id=example-1-simple-configuration-no-templating>Example 1: Simple Configuration, no templating<a hidden class=anchor aria-hidden=true href=#example-1-simple-configuration-no-templating>#</a></h3><p>Let start with something simple, like preparing a generic base image. You save this in your <code>build.yaml</code> file (or whatever you would provide to <code>--config</code> flag).</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Define your config file: build.yaml</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>images</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>base/Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.18&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.19&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>BASEIMAGE</span>: <span style=color:#ae81ff>alpine:{{ .alpine }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}</span>
</span></span></code></pre></div></div></div><br><h4 id=fields-description>Fields Description<a hidden class=anchor aria-hidden=true href=#fields-description>#</a></h4><ul><li><code>images</code>: The root key for defining different images.</li><li><code>base</code>: The name of the image. Name it as</li><li><code>dockerfile</code>: The path to the Dockerfile or Dockerfile template (<code>.tpl</code> extension).</li><li><code>variables</code>: Variables to be used in the template.</li><li><code>alpine</code>: A variable which represents list of Alpine versions.</li><li><code>args</code>: Arguments that will be passed as <code>--build-arg</code>, during the image build.</li><li><code>tags</code>: The tags to be applied to the generated images, plus templated values.</li><li><code>{{ .tag }} </code>: Is a value provided to <code>--tag</code> parameter, usually a version of your image.</li></ul><p>Let choose really basic, base image:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>base/Dockerfile</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>ARG</span> BASEIMAGE<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>${BASEIMAGE</span><span style=color:#f92672>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;echo&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br></p><p>Assuming you already <a href="https://github.com/tgagor/template-dockerfiles?tab=readme-ov-file#installation" target=_blank>installed the tool<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>, let generate templates by calling:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Build images</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>td --config build.yaml --tag 1.0.0 --build
</span></span></code></pre></div></div></div><br><p>It&rsquo;s a simple config file but there&rsquo;s already a lot happening there. It will produce 5 Docker images, one per each Alpine version and will tag them according to the rules. Thanks to that we already have multiple patterns, from which your developers can choose</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Built images</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker image ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REPOSITORY   TAG                 IMAGE ID       CREATED        SIZE
</span></span><span style=display:flex><span>base         1.0.0              bb5fa559eff4   <span style=color:#ae81ff>3</span> months ago   12.1MB
</span></span><span style=display:flex><span>base         1.0.0-alpine3      bb5fa559eff4   <span style=color:#ae81ff>3</span> months ago   12.1MB
</span></span><span style=display:flex><span>base         1.0.0-alpine3.20   bb5fa559eff4   <span style=color:#ae81ff>3</span> months ago   12.1MB
</span></span><span style=display:flex><span>base         1.0.0-alpine3.19   5e664aff1066   <span style=color:#ae81ff>3</span> months ago   11.5MB
</span></span><span style=display:flex><span>base         1.0.0-alpine3.18   87b441f4c072   <span style=color:#ae81ff>3</span> months ago   11.5MB
</span></span></code></pre></div></div></div><br><p>If you would like to introduce <a href=https://alpinelinux.org/posts/Alpine-3.21.0-released.html target=_blank>just released Alpine 3.21<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>, it&rsquo;s just one line more in the config file.</p><h3 id=example-2-simple-configuration-with-templating>Example 2: Simple configuration with templating<a hidden class=anchor aria-hidden=true href=#example-2-simple-configuration-with-templating>#</a></h3><p>We went through simplest example, so it&rsquo;s time to rise the bar. We will use <code>Dockerfile.tpl</code> now and we don&rsquo;t need <code>args</code> anymore. We will also introduce Alpine 3.21, which for some reason would require to do something differently than other versions. We will also add one more tag, to simplify referring to specific Alpine&rsquo;s version. Final config will be:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Define your config file: build.yaml</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>images</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>base/Dockerfile.tpl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.18&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.19&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.21&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}</span>
</span></span></code></pre></div></div></div><br><p>Our template is just slightly different as it have to &ldquo;react&rdquo; to this &ldquo;breaking change&rdquo; in Alpine 3.21. It would be easy to use <code>bash</code> conditions to react to different Alpine version in <code>RUN</code> directives, but it&rsquo;s not easy to do the same for <code>CMD</code> - at least, not without custom entrypoint. As Go-Lang templates, provide us conditions and loops, we can do really crazy things in those templates, but please - don&rsquo;t &#x1f609;.</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>base/Dockerfile.tpl</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>alpine</span>:<span style=color:#f92672>{{</span> .alpine <span style=color:#f92672>}}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>{{</span> <span style=color:#66d9ef>if</span> eq .alpine <span style=color:#e6db74>&#34;3.21&#34;</span> <span style=color:#f92672>}}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> echo this is alpine 3.21 specific<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>{{</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>}}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> echo this is generic<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>{{</span> end <span style=color:#f92672>}}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div></div></div><br><p>Build command stays the same, but we will bump a minor version<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:<div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Build images</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>td --config build.yaml --tag 1.1.0 --build
</span></span></code></pre></div></div></div><br></p><p>And the result will be:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Result images</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker image ls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>REPOSITORY   TAG                 IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>base         alpine3.18          c46557602bb4   <span style=color:#ae81ff>30</span> minutes ago   11.5MB
</span></span><span style=display:flex><span>base         v1.1.0-alpine3.18   c46557602bb4   <span style=color:#ae81ff>30</span> minutes ago   11.5MB
</span></span><span style=display:flex><span>base         alpine3.19          ecc2bc3541fe   <span style=color:#ae81ff>30</span> minutes ago   11.5MB
</span></span><span style=display:flex><span>base         v1.1.0-alpine3.19   ecc2bc3541fe   <span style=color:#ae81ff>30</span> minutes ago   11.5MB
</span></span><span style=display:flex><span>base         alpine3.20          0319369f1076   <span style=color:#ae81ff>30</span> minutes ago   12.1MB
</span></span><span style=display:flex><span>base         v1.1.0-alpine3.20   0319369f1076   <span style=color:#ae81ff>30</span> minutes ago   12.1MB
</span></span><span style=display:flex><span>base         alpine3             9d78f7b4ccac   <span style=color:#ae81ff>30</span> minutes ago   12.2MB
</span></span><span style=display:flex><span>base         alpine3.21          9d78f7b4ccac   <span style=color:#ae81ff>30</span> minutes ago   12.2MB
</span></span><span style=display:flex><span>base         v1.1.0              9d78f7b4ccac   <span style=color:#ae81ff>30</span> minutes ago   12.2MB
</span></span><span style=display:flex><span>base         v1.1.0-alpine3      9d78f7b4ccac   <span style=color:#ae81ff>30</span> minutes ago   12.2MB
</span></span><span style=display:flex><span>base         v1.1.0-alpine3.21   9d78f7b4ccac   <span style=color:#ae81ff>30</span> minutes ago   12.2MB
</span></span></code></pre></div></div></div><br><p>Let test the result:</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>~/2025/01/efficient-dockerfile-templating-for-complex-build-scenarios/</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ docker run -ti --rm base:alpine3.18
</span></span><span style=display:flex><span>this is generic
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ docker run -ti --rm base:alpine3.21
</span></span><span style=display:flex><span>this is alpine 3.21 specific
</span></span></code></pre></div></div></div><br><p>Let check again what happen here. With quite the same configuration and a template of Dockerfile we&rsquo;ve been able to generate 4 different images (1 per Alpine&rsquo;s version), with 11 tags just to make the choice for people easier. Tags are generated in order, and variable&rsquo;s values are also ordered so latest version of Alpine (listed as last one) is the new default.</p><p>It&rsquo;s really clean and easy to follow, what happens here, which would be even more important in the next example &#x1f609;</p><h3 id=example-3-complex-configuration>Example 3: Complex Configuration<a hidden class=anchor aria-hidden=true href=#example-3-complex-configuration>#</a></h3><p>I used Tomcat as an example earlier and this will be our next example. I know, that there are ready to use images, but it&rsquo;s just a good, complex enough example &#x1f604;</p><div class="terminal space shadow"><div class=top><div class=btns><span class="circle red"></span>
<span class="circle yellow"></span>
<span class="circle green"></span></div><div class=title>Example config file: tomcat.yaml</div></div><div class=terminalbody><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>registry</span>: <span style=color:#ae81ff>repo.local</span>
</span></span><span style=display:flex><span><span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>base</span>
</span></span><span style=display:flex><span><span style=color:#f92672>maintainer</span>: <span style=color:#ae81ff>Tomasz GƒÖgor &lt;https://gagor.pro&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.vendor</span>: <span style=color:#ae81ff>My Corp</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.licenses</span>: <span style=color:#ae81ff>GPL-3.0-only</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.url</span>: <span style=color:#ae81ff>https://my.url</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.documentation</span>: <span style=color:#ae81ff>https://my.url/docs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.title</span>: <span style=color:#ae81ff>My Corp&#39;s Docker base images</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>org.opencontainers.image.description</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    This is a longer description of what this image is capable of.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    You might be setting your own timezone or preferred language settings
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    and explain it nicely here.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Some labels will be added by the tool automatically too.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>images</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>base</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>base/Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.21&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>BASEIMAGE</span>: <span style=color:#ae81ff>alpine:{{ .alpine }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:{{ .tag }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>base:latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jdk</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>jdk/Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.21&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>java</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>BASEIMAGE</span>: <span style=color:#ae81ff>openjdk:{{ .java }}-jdk-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .tag }}-{{ .java }}-jdk-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .tag }}-{{ .java }}-jdk-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .java }}-jdk-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .java }}-jdk</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:{{ .tag }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jdk:latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>jre</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>jre/Dockerfile</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.21&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>java</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>args</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>BASEIMAGE</span>: {{ <span style=color:#ae81ff>.registry }}/{{ .prefix }}/jdk:{{ .java }}-jdk-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .tag }}-{{ .java }}-jre-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .tag }}-{{ .java }}-jre-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .java }}-jre-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .java }}-jre</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:{{ .tag }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>jre:latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tomcat</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>dockerfile</span>: <span style=color:#ae81ff>tomcat/Dockerfile.tpl</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>alpine</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.20&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;3.21&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>java</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>17</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>tomcat</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>9.0.98</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>10.1.34</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>11.0.2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>excludes</span>:
</span></span><span style=display:flex><span>      <span style=color:#75715e># follow minimum required version</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># https://tomcat.apache.org/whichversion.html</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>tomcat</span>: <span style=color:#ae81ff>11.0.2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>java</span>: <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>tomcat</span>: <span style=color:#ae81ff>11.0.2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>java</span>: <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>tomcat</span>: <span style=color:#ae81ff>10.1.34</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>java</span>: <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-tomcat{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat }}-jdk{{ .java }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat | splitList &#34;.&#34; | first }}-jdk{{ .java }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat | splitList &#34;.&#34; | first }}-jdk{{ .java }}-alpine{{ .alpine | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat }}-jdk{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat }}-jdk{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat | splitList &#34;.&#34; | first }}-jdk{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat | splitList &#34;.&#34; | first }}-jdk{{ .java }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tag }}-{{ .tomcat | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:{{ .tomcat | splitList &#34;.&#34; | first }}</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>tomcat:latest</span>
</span></span></code></pre></div></div></div><br><h4 id=fields-description-1>Fields Description<a hidden class=anchor aria-hidden=true href=#fields-description-1>#</a></h4><ul><li><code>registry</code>: URL to our private registry.</li><li><code>prefix</code>: Add a <code>base</code> prefix to each image.</li><li><code>maintainer</code>: A contact team or person.</li><li><code>labels</code>: Bunch of <a href=https://github.com/opencontainers/image-spec/blob/main/annotations.md target=_blank>OCI Label Schema<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>labels.</li><li><code>excludes</code>: Variants we don&rsquo;t want to build.</li><li>rest as in the simple example.</li></ul><p>I won&rsquo;t be showing Dockerfiles here, as the main actor here is configuration. It would be extremely hard to follow such structure with all those variations with bash scripts or Makefiles. It&rsquo;s around 100 lines of configuration, easy to read and understand that will produce tens of image variants, that can be used by your developers in a way they need. Templating abilities on <code>tags</code>, <code>args</code> or <code>labels</code> allow to dynamically describe our images.</p><p>That&rsquo;s the final I wanted to achieve. Simple recipe to deliver complex build strategies for Docker images.</p><h3 id=more-examples>More Examples<a hidden class=anchor aria-hidden=true href=#more-examples>#</a></h3><p>I will try to update and curate a list of good examples of <code>td</code> usage in the wild. For now, it&rsquo;s mostly mine stuff:</p><ol><li><p><a href=https://github.com/tgagor/docker-centos target=_blank>https://github.com/tgagor/docker-centos<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span></a></p><p>Weekly updated CentOS Stream images. <code>td</code> for building, <a href=https://github.com/tgagor/docker-centos/blob/master/.github/workflows/build.yml target=_blank>Github actions<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>for versioning, security scans. That&rsquo;s really a simple example to start with.</p></li><li><p><a href=https://github.com/tgagor/template-dockerfiles/tree/main/example target=_blank>https://github.com/tgagor/template-dockerfiles/tree/main/example<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span></a></p><p>Examples in the <a href=https://github.com/tgagor/template-dockerfiles target=_blank><code>td</code> repo<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>. They show how to build <a href=https://aws.amazon.com/corretto/ target=_blank>Corretto<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>images based on Alpine Linux in JDK and JRE variants.</p></li><li><p><a href=https://github.com/tgagor/docker-chisel target=_blank>https://github.com/tgagor/docker-chisel<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span></a></p><p><a href=https://ubuntu.com/blog/craft-custom-chiselled-ubuntu-distroless target=_blank>Cannonical released<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>interesting <a href=https://github.com/canonical/chisel target=_blank>tool called Chisel<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>. It allows to &ldquo;cut&rdquo; minimal versions of Docker images by extracting only binary dependencies required to run our app. It allows to compete with Alpine&rsquo;s images on size, but with standard glibc.</p><p><strong>It&rsquo;s a complete, multi-platform build with Github actions for automatic builds!</strong></p></li></ol><h2 id=what-more-you-can-do>What more you can do?<a hidden class=anchor aria-hidden=true href=#what-more-you-can-do>#</a></h2><p>I plan to extend the capabilities of the tool to include:</p><ol><li>Image squashing for reducing the number of layers (<code>--squash</code> flag, already supported).</li><li>Different compression options for even better size optimizations out of the box. As savings in the base images accumulate in all child images.</li><li>Multi-platform builds support.</li></ol><hr><p>Enjoyed?
<a class=kofi href=https://ko-fi.com/tgagor target=_blank><img height=36 style=border:0;height:36px src='https://storage.ko-fi.com/cdn/kofi5.png?v=3' border=0 alt='Buy Me a Coffee at ko-fi.com'></a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://en.wikipedia.org/wiki/Cyber-security_regulation target=_blank>https://en.wikipedia.org/wiki/Cyber-security_regulation<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://jinja.palletsprojects.com/en/stable/ target=_blank>https://jinja.palletsprojects.com/en/stable/<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=http://masterminds.github.io/sprig/ target=_blank>http://masterminds.github.io/sprig/<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://semver.org/spec/v2.0.0.html target=_blank>https://semver.org/spec/v2.0.0.html<span style=white-space:nowrap>&#8201;<svg style="height:.7em;width:.7em" focusable="false" data-prefix="fas" data-icon="external-link-alt" class="svg-inline--fa fa-external-link-alt fa-w-16" role="img" viewBox="0 0 512 512"><title>external link</title><path fill="currentColor" d="M432 320H4e2a16 16 0 00-16 16V448H64V128H208a16 16 0 0016-16V80a16 16 0 00-16-16H48A48 48 0 000 112V464a48 48 0 0048 48H4e2a48 48 0 0048-48V336a16 16 0 00-16-16zM488 0H360c-21.37.0-32.05 25.91-17 41l35.73 35.73L135 320.37a24 24 0 000 34L157.67 377a24 24 0 0034 0L435.28 133.32 471 169c15 15 41 4.5 41-17V24A24 24 0 00488 0z"/></svg></span> </a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://gagor.pro/tag/best-practices/>Best Practices</a></li><li><a href=https://gagor.pro/tag/devops/>DevOps</a></li><li><a href=https://gagor.pro/tag/docker/>Docker</a></li><li><a href=https://gagor.pro/tag/linux/>Linux</a></li></ul><nav class=paginav><a class=prev href=https://gagor.pro/2025/02/ata1.00-failed-command-read-fpdma-queued/><span class=title>¬´ Prev</span><br><span>ata1.00: failed command: READ FPDMA QUEUED</span>
</a><a class=next href=https://gagor.pro/2024/05/fix-cannot-rebase-onto-multiple-branches-error-once-and-for-all/><span class=title>Next ¬ª</span><br><span>Fix 'Cannot Rebase Onto Multiple Branches' error once and for all</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on x" href="https://x.com/intent/tweet/?text=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios&amp;url=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f&amp;hashtags=Bestpractices%2cDevOps%2cDocker%2cLinux"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f&amp;title=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios&amp;summary=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios&amp;source=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f&title=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on whatsapp" href="https://api.whatsapp.com/send?text=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios%20-%20https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on telegram" href="https://telegram.me/share/url?text=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios&amp;url=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Efficient Dockerfile templating for complex build scenarios on ycombinator" href="https://news.ycombinator.com/submitlink?t=Efficient%20Dockerfile%20templating%20for%20complex%20build%20scenarios&u=https%3a%2f%2fgagor.pro%2f2025%2f01%2fefficient-dockerfile-templating-for-complex-build-scenarios%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=tgagor/tgagor.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkzOTg4MDg1Mw==" data-category=Announcements data-category-id=DIC_kwDOAmCIlc4CcAtN data-mapping=pathname data-strict=1 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=transparent_dark data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span><a href=https://gagor.pro/>Tom's Blog</a> &copy; 2008-2025</span>
<span>Content licensed under <a rel="license noopener noreferrer" target=_blank href=https://creativecommons.org/licenses/by-sa/4.0/>(CC BY-SA 4.0)</a></span></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "8d51d5292abd4c77bad90db038659671"}'></script><script defer src=https://analytics.ahrefs.com/analytics.js data-key=ngiuUolR4+T0MnN5eV7I/A async></script><script src="https://www.clarity.ms/tag/u52dj1wa2c?ref=bwt" async></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>