<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="PolubiÅ‚em Nginx&rsquo;a i wykorzystujÄ™ go na coraz wiÄ™cej sposobÃ³w. Kilka rzeczy udaÅ‚o mi siÄ™ caÅ‚kiem fajnie w nim skonfigurowaÄ‡ i postanowiÅ‚em zebraÄ‡ te przykÅ‚ady by nastÄ™pnym razem gdy postanowiÄ™ do nich siÄ™gnÄ…Ä‡ nie musieÄ‡ wertowaÄ‡ konfigÃ³w po serwerach ğŸ˜ƒ
SÅ‚owo wstÄ™pu NiektÃ³re rewrite&rsquo;y koÅ„czÄ… siÄ™ znakiem ? - czemu?
OtÃ³Å¼ Nginx prÃ³buje automatycznie dodawaÄ‡ parametry na koÅ„cu przepisanego adresu. JeÅ›li jednak wykorzystamy zmiennÄ… $request_uri to ona sama w sobie zawiera juÅ¼ parametry zapytania (czyli to co w URI znajduje siÄ™ po znaku ?"><meta name=theme-color content="#c64858"><meta property="og:title" content="Nginx - przydatne rewriteâ€™y i rÃ³Å¼ne sztuczki â€¢ TiMoR"><meta property="og:description" content="PolubiÅ‚em Nginx&rsquo;a i wykorzystujÄ™ go na coraz wiÄ™cej sposobÃ³w. Kilka rzeczy udaÅ‚o mi siÄ™ caÅ‚kiem fajnie w nim skonfigurowaÄ‡ i postanowiÅ‚em zebraÄ‡ te przykÅ‚ady by nastÄ™pnym razem gdy postanowiÄ™ do nich siÄ™gnÄ…Ä‡ nie musieÄ‡ wertowaÄ‡ konfigÃ³w po serwerach ğŸ˜ƒ
SÅ‚owo wstÄ™pu NiektÃ³re rewrite&rsquo;y koÅ„czÄ… siÄ™ znakiem ? - czemu?
OtÃ³Å¼ Nginx prÃ³buje automatycznie dodawaÄ‡ parametry na koÅ„cu przepisanego adresu. JeÅ›li jednak wykorzystamy zmiennÄ… $request_uri to ona sama w sobie zawiera juÅ¼ parametry zapytania (czyli to co w URI znajduje siÄ™ po znaku ?"><meta property="og:url" content="https://timor.site/2013/09/nginx-przydatne-rewritey-i-rozne-sztuczki/"><meta property="og:site_name" content="timor's site"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/cfa9a17577371083824a78c303cc8ed7?s=256"><meta property="article:section" content="posts"><meta property="article:tag" content="Linux"><meta property="article:tag" content="nginx"><meta property="article:published_time" content="2013-09-09T00:00:00Z"><meta property="article:modified_time" content="2013-09-09T00:00:00Z"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.76.5"><title>Nginx - przydatne rewriteâ€™y i rÃ³Å¼ne sztuczki â€¢ TiMoR</title><link rel=canonical href=https://timor.site/2013/09/nginx-przydatne-rewritey-i-rozne-sztuczki/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#c64858}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-88996819-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="page type-posts layout-post has-sidebar"><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu>Skip to Main Menu</a><div class=container><section class="widget widget-about sep-after"><header><div class=logo><a href=/><img src=/favicon.ico></a></div><h2 class="title site-title"><a href=/>timor's site</a></h2><div class=desc>Linux configuration, Automation, Security - Sysadmin/DevOps blog</div></header></section><section class="widget widget-search sep-after"><header><h4 class="title widget-title">Search</h4></header><form action=/search id=search-form class=search-form><label><span class=screen-reader-text>Search</span>
<input id=search-term class=search-term type=search name=q placeholder=Search&mldr;></label></form></section><section class="widget widget-sidebar_menu sep-after"><nav id=sidebar-menu class="menu sidebar-menu" aria-label="Sidebar Menu"><div class=container><ul><li class=item><a href=/></a></li><li class=item><a href=/>Home</a></li><li class="item has-children"><a href=/categories/howto/>HOWTO</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span></button><ul class=sub-menu><li class=item><a href=/categories/tip/>Tips</a></li></ul></li><li class=item><a href=/categories/off-topic/>Off-topic</a></li><li class=item><a href=/categories/gotowanie/>Gotowanie</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav></section></div><div class=sidebar-overlay></div></div><div class=main><a class=screen-reader-text href=#content>Skip to Content</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><span>Nginx - przydatne rewriteâ€™y i rÃ³Å¼ne sztuczki</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">timor's site</p><p class="desc site-desc">Linux configuration, Automation, Security - Sysadmin/DevOps blog</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Nginx - przydatne rewriteâ€™y i rÃ³Å¼ne sztuczki</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2013-09-09T00:00:00Z>2013-09-09</time></span>
<span class=byline><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M21 21V20c0-2.76-4-5-9-5s-9 2.24-9 5v1"/><path d="M16 6.37A4 4 0 1112.63 3 4 4 0 0116 6.37z"/></svg><span class=screen-reader-text>by </span><a href=/authors/timor>TiMoR</a></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>6 mins read</span></div></div></header><div class="container entry-content"><p>PolubiÅ‚em Nginx&rsquo;a i wykorzystujÄ™ go na coraz wiÄ™cej sposobÃ³w. Kilka rzeczy udaÅ‚o mi siÄ™ caÅ‚kiem fajnie w nim skonfigurowaÄ‡ i postanowiÅ‚em zebraÄ‡ te przykÅ‚ady by nastÄ™pnym razem gdy postanowiÄ™ do nich siÄ™gnÄ…Ä‡ nie musieÄ‡ wertowaÄ‡ konfigÃ³w po serwerach ğŸ˜ƒ</p><h2 id=sÅ‚owo-wstÄ™pu>SÅ‚owo wstÄ™pu</h2><p>NiektÃ³re rewrite&rsquo;y koÅ„czÄ… siÄ™ znakiem <code>?</code> - czemu?</p><p>OtÃ³Å¼ Nginx prÃ³buje automatycznie dodawaÄ‡ parametry na koÅ„cu przepisanego adresu. JeÅ›li jednak wykorzystamy zmiennÄ… <code>$request_uri</code> to ona sama w sobie zawiera juÅ¼ parametry zapytania (czyli to co w URI znajduje siÄ™ po znaku <code>?</code>) i wÅ‚aÅ›nie dodanie pytajnika tuÅ¼ za tÄ… zmiennÄ… powoduje Å¼e argumenty nie sÄ… dublowane.</p><p>Ma to teÅ¼ zastosowanie gdy chcemy by <code>rewrite</code> kierowaÅ‚ np. na gÅ‚Ã³wnÄ… stronÄ™ beÅ¼ Å¼adnych dodatkowych argumentÃ³w (zostanÄ… one obciÄ™te).<br><a href=http://wiki.nginx.org/HttpRewriteModule#rewrite>WiÄ™cej na ten temat moÅ¼na znaleÅºÄ‡ w dokumentacji Nginx</a>.</p><p>Inna warta wspomnienia uwaga dotyczy drobnej optymalizacji, o ktÃ³rej warto pamiÄ™taÄ‡ na etapie tworzenia rewrite&rsquo;Ã³w (moÅ¼na znaleÅºÄ‡ masÄ™ kiepskich przykÅ‚adÃ³w w sieci): na poczÄ…tku najlepiej jest stworzyÄ‡ coÅ› co dziaÅ‚a (i przy maÅ‚ym ruchu moÅ¼e to byÄ‡ wystarczajÄ…ce) a pÃ³Åºniej optymalizowaÄ‡ - moje przykÅ‚ady staraÅ‚em siÄ™ zoptymalizowaÄ‡ wedÅ‚ug zalecanych praktyk.<br>Dlatego zamiast pisaÄ‡:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>rewrite</span> <span style=color:#e6db74>^(.*)</span>$ $scheme://www.domain.com$1 <span style=color:#e6db74>permanent</span>;
</code></pre></div><p>lepiej napisaÄ‡:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>rewrite</span> <span style=color:#e6db74>^</span> $scheme://www.domain.com$request_uri? <span style=color:#e6db74>permanent</span>;
</code></pre></div><p>(nie wykorzystujemy przechowywania wartoÅ›ci dopasowania - mniejsze zuÅ¼ycie pamiÄ™ci i lÅ¼ejsza interpretacja REGEXP&rsquo;a).<br>A jeszcze lepiej napisaÄ‡:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>return</span> <span style=color:#ae81ff>301</span> $scheme://www.domain.com$request_uri;
</code></pre></div><p>(w ogÃ³le nie wykorzystujemy REGEXP&rsquo;Ã³w praktycznie zerowy narzut na przetwarzanie) - dziÄ™ki za uwagÄ™: lukasamd.</p><h2 id=przekierowanie-starej-domeny-na-nowÄ…>Przekierowanie starej domeny na nowÄ…</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>old-domain.com</span> <span style=color:#e6db74>www.old-domain.com</span>;
    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> $scheme://www.new-domain.com$request_uri;
    <span style=color:#75715e># rewrite ^ $scheme://www.new-domain.com$request_uri? permanent;
</span><span style=color:#75715e></span>    <span style=color:#75715e># or
</span><span style=color:#75715e></span>    <span style=color:#75715e># rewrite ^ $scheme://www.new-domain.com? permanent;
</span><span style=color:#75715e></span>}
</code></pre></div><p>Wykorzystanie return w tej sytuacji jest nieco bardziej optymalne gdyÅ¼ nie angaÅ¼uje w ogÃ³le silnika REGEXP a w tej sytuacji jest wystarczajÄ…ce.<br>Pierwsza linia z rewrite i $request_uri spowoduje przepisywanie teÅ¼ parametrÃ³w wywoÅ‚aÅ„ do nowej lokalizacji co jest jak najbardziej sensowne gdy pomimo domeny nie zmieniÅ‚a siÄ™ zbytnio struktura strony.</p><p>JeÅ›li strona jednak siÄ™ zmieniÅ‚a to moÅ¼emy zdecydowaÄ‡ o przekierowaniu bez parametrÃ³w - po prostu na gÅ‚Ã³wnÄ… stronÄ™ - i to robi druga linia.</p><p>W obu przypadkach parametr <code>permanent</code> nakazuje uÅ¼ycie kodu przekierowania HTTP 301 (Moved Permanently), co uÅ‚atwi zorientowanie siÄ™ crawlerom Å¼e ta zmiana jest juÅ¼ na staÅ‚e.</p><h2 id=dodanie-www-na-poczÄ…tku-domeny>Dodanie WWW na poczÄ…tku domeny</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>domaim.com</span>;
    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> $scheme://www.domain.com$request_uri;
    <span style=color:#75715e>#rewrite ^ $scheme://www.domain.com$request_uri? permanent;
</span><span style=color:#75715e></span>    <span style=color:#75715e># or
</span><span style=color:#75715e></span>    <span style=color:#75715e>#rewrite ^(.*)$ $scheme://www.domain.com$1 permanent;
</span><span style=color:#75715e></span>}
</code></pre></div><p>PrzykÅ‚ad zakomentowany jest wedÅ‚ug dokumentacji mniej optymalny ale rÃ³wnieÅ¼ zadziaÅ‚a. Reszta jest prosta i samoopisujÄ…ca siÄ™ ğŸ˜ƒ</p><p>A to jeszcze bardziej ogÃ³lna wersja dla wielu domen:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> 195.117.254.80:<span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>domain.pl</span> <span style=color:#e6db74>domain.eu</span> <span style=color:#e6db74>domain.com</span>;

    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> $scheme://www.$http_host$request_uri;
    <span style=color:#75715e>#rewrite ^ $scheme://www.$http_host$request_uri? permanent;
</span><span style=color:#75715e></span>}
</code></pre></div><p>Ta wersja wykorzystuje zmiennÄ… <code>$http_host</code> do przekierowania na domenÄ™ z zapytania (zmienna ta zawiera teÅ¼ numer portu jeÅ›li jest niestandardowy np. 8080, w przeciwieÅ„stwie do zmiennej <code>$host</code>, ktÃ³ra zawiera tylko domenÄ™).</p><h2 id=usuniÄ™cie-www-z-poczÄ…tku-domeny>UsuniÄ™cie WWW z poczÄ…tku domeny</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>www.domain.com</span>;
    <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> $scheme://domain.com$request_uri;
    <span style=color:#75715e>#rewrite ^ $scheme://domain.com$request_uri? permanent;
</span><span style=color:#75715e></span>}
</code></pre></div><p>Czasami moÅ¼e siÄ™ przydaÄ‡ jeszcze inny kawaÅ‚ek, gdy strona dziaÅ‚a na wielu domenach i chcemy przekierowaÄ‡ wszystkie:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>www.domain.com</span> <span style=color:#e6db74>_</span> ;
    <span style=color:#75715e># server_name www.domain1.com www.domain2.com www.domain3.eu www.domain.etc.com;
</span><span style=color:#75715e></span>
    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$host ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>www\.(.*))</span> {
        <span style=color:#f92672>set</span> $pure_host $1;
        <span style=color:#f92672>return</span> <span style=color:#ae81ff>301</span> $scheme://$pure_host$request_uri;
        <span style=color:#75715e>#rewrite ^ $scheme://$pure_host$request_uri? permanent;
</span><span style=color:#75715e></span>        <span style=color:#75715e>#rewrite ^(.*)$ $scheme://$pure_host$1 permanent;
</span><span style=color:#75715e></span>    }
}
</code></pre></div><p>ChoÄ‡ to podejÅ›cie nie jest zalecane (pomimo zwiÄ™zÅ‚oÅ›ci). Lepiej zdefiniowaÄ‡ dwa bloki server z domenami www.* i domenami bez www na poczÄ…tku. Ale z drugiej strony to cholernie wygodne&mldr; ğŸ˜ƒ</p><h2 id=przekierowanie-pozostaÅ‚ych-zapytaÅ„-na-domyÅ›lnÄ…-domenÄ™>Przekierowanie &ldquo;pozostaÅ‚ych&rdquo; zapytaÅ„ na domyÅ›lnÄ… domenÄ™</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span> <span style=color:#e6db74>default</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>_</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> $scheme://www.domena.com;
    <span style=color:#75715e>#rewrite ^ $scheme://www.domena.com/search/$host;
</span><span style=color:#75715e></span>}
</code></pre></div><p>To bardzo przydatny przykÅ‚ad - czyli domyÅ›lny vhost, ktÃ³ry &ldquo;przyjmie&rdquo; wszystkie zapytania do domen nie zdefiniowanych w konfiguracji i przekieruje na naszÄ… &ldquo;gÅ‚Ã³wnÄ… stronÄ™&rdquo;.</p><p>Zakomentowany przykÅ‚ad jest nieco bardziej przekombinowany bo prÃ³buje wykorzystaÄ‡ wyszukiwarkÄ™ na naszej stronie do wyszukania &ldquo;czegoÅ›&rdquo; pomocnego - z tym przykÅ‚adem naleÅ¼y uwaÅ¼aÄ‡ bo jeÅ›li do serwera trafi duÅ¼o bÅ‚Ä™dnych zapytaÅ„ to moÅ¼e zostaÄ‡ przeciÄ…Å¼ony &ldquo;bzdetnymi&rdquo; wyszukiwaniami.</p><h2 id=przekierowanie-pewnych-podstron-po-zmianie-struktury-strony>Przekierowanie pewnych podstron po zmianie struktury strony</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>listen</span> <span style=color:#ae81ff>80</span>;
    <span style=color:#f92672>server_name</span> <span style=color:#e6db74>www.domain.com</span>;

    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>try_files</span> $uri $uri/ <span style=color:#e6db74>@rewrites</span>;
    }

    <span style=color:#f92672>location</span> <span style=color:#e6db74>@rewrites</span> {
        <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/tag/something</span>  $scheme://new.domain.com <span style=color:#e6db74>permanent</span>;
        <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/category/hobby</span> <span style=color:#e6db74>/category/painting</span> <span style=color:#e6db74>permanent</span>;
        <span style=color:#75715e># etc ...
</span><span style=color:#75715e></span>
        <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> <span style=color:#e6db74>/index.php</span> <span style=color:#e6db74>last</span>;
    }
}
</code></pre></div><p>Im starsza strona tym wiÄ™cej zbiera siÄ™ linkÃ³w, ktÃ³rych po prostu nie moÅ¼na usunÄ…Ä‡, a ktÃ³re z racji wprowadzonych zmian nie majÄ… prawa bytu w nowym ukÅ‚adzie. Warto je przekierowaÄ‡ w nowe miejsca, lub najbardziej odpowiadajÄ…ce/bliskie tym starym. Problemem moÅ¼e siÄ™ wkrÃ³tce staÄ‡ duÅ¼a lista przekierowaÅ„, ktÃ³ra zaciemni konfiguracjÄ™.<br>PowyÅ¼szy sposÃ³b w doÅ›Ä‡ optymalny sposÃ³b porzÄ…dkuje takie przekierowania - najpierw sprawdza czy przypadkiem nie prÃ³bujemy pobraÄ‡ istniejÄ…cych plikÃ³w, jeÅ›li nie to wrzuca nas nas na listÄ™ przekierowaÅ„, a jeÅ›li i tu nic nie znajdzie to zapytanie przekazywane jest do gÅ‚Ã³wnego skryptu strony.</p><h2 id=przekierowanie-w-zaleÅ¼noÅ›ci-od-wartoÅ›ci-parametru-w-uri>Przekierowanie w zaleÅ¼noÅ›ci od wartoÅ›ci parametru w URI</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>if</span> <span style=color:#e6db74>(</span>$args ~ <span style=color:#e6db74>producent=toyota)</span>{
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> $scheme://toyota.domena.com$request_uri? <span style=color:#e6db74>permanent</span>;
}
</code></pre></div><p>To rzadko stosowane przekierowanie a w dodatku maÅ‚o czytelnie i ponoÄ‡ maÅ‚o wydajne&mldr; Ale potrafi byÄ‡ bardzo przydatne gdy chcemy przepisaÄ‡ adres w zaleÅ¼noÅ›ci od wartoÅ›ci parametru np. gdy pewna podstrona doczeka siÄ™ rozbudowy w zupeÅ‚nie nowym serwisie lub gdy chcemy Å‚adnie przekierowaÄ‡ adresy ze starej strony na nowÄ….</p><h2 id=blokowanie-dostÄ™pu-do-ukrytych-plikÃ³w>Blokowanie dostÄ™pu do ukrytych plikÃ³w</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> ~ <span style=color:#e6db74>/\.</span> { <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>; }
</code></pre></div><p>PrzyznajÄ™ - to nie rewrite&mldr; Ale ta linijka jest rÃ³wnie przydatna - pozwala zablokowaÄ‡ moÅ¼liwoÅ›Ä‡ pobierania ukrytych plikÃ³w (np. .htaccess&rsquo;Ã³w po konfiguracji z Apachego).</p><h2 id=wyÅ‚Ä…czenie-logowania-dla-robotstxt-i-faviconico>WyÅ‚Ä…czenie logowania dla robots.txt i favicon.ico</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> = <span style=color:#e6db74>/favicon.ico</span> { <span style=color:#f92672>try_files</span> <span style=color:#e6db74>/favicon.ico</span> =<span style=color:#ae81ff>204</span>; <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; }
<span style=color:#66d9ef>location</span> = <span style=color:#e6db74>/robots.txt</span>  { <span style=color:#f92672>try_files</span> <span style=color:#e6db74>/robots.txt</span> =<span style=color:#ae81ff>204</span>; <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; }
</code></pre></div><p>To teÅ¼ nie rewrite - ale bardzo fajnie obsÅ‚uguje sytuacjÄ™ gdy mamy i gdy nie mamy powyÅ¼szych dwÃ³ch pliczkÃ³w. Po pierwsze wyÅ‚Ä…cza logowanie i serwuje je gdy sÄ… dostÄ™pne. Gdy nie istniejÄ… to serwuje puste pliki (kod 204) dziÄ™ki czemu nie przeszkadzajÄ… nam 404-ki ğŸ˜ƒ</p><h2 id=blokowanie-dostÄ™pu-do-obrazkÃ³w-dla-nieznanych-referererÃ³w>Blokowanie dostÄ™pu do obrazkÃ³w dla nieznanych referererÃ³w</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>^.+\.(?:jpg|png|css|gif|jpeg|js|swf)</span>$ {
    <span style=color:#75715e># definiujemy poprawnych refererow
</span><span style=color:#75715e></span>    <span style=color:#f92672>valid_referers</span> <span style=color:#e6db74>none</span> <span style=color:#e6db74>blocked</span> <span style=color:#e6db74>*.domain.com</span> <span style=color:#e6db74>domain.com</span>;
    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$invalid_referer<span style=color:#e6db74>)</span>  {
        <span style=color:#f92672>return</span> <span style=color:#ae81ff>444</span>;
    }
    <span style=color:#f92672>expires</span> <span style=color:#e6db74>max</span>;
    <span style=color:#f92672>break</span>;
}

</code></pre></div><p>Zabezpieczenie warte tyle co nic bo banalne do ominiÄ™cia - ale jeÅ›li zdarzy siÄ™ Å¼e ktoÅ› postanowi wykorzystaÄ‡ grafikÄ™ z naszej stronki np. w aukcji na allegro czy wÅ‚asnym sklepie to tÄ… prostÄ… sztuczkÄ… moÅ¼emy go przyciÄ…Ä‡ i przewaÅ¼nie jest to wystarczajÄ…ce.<br>MuszÄ™ teÅ¼ zaznaczyÄ‡ szczegÃ³lne znaczenie wartoÅ›ci kodu bÅ‚Ä™du 444 w Nginx&rsquo;ie - powoduje on zerwanie poÅ‚Ä…czenia bez wysyÅ‚ania jakiejkolwiek odpowiedzi. JeÅ›li nie chcemy byÄ‡ tak okrutni to moÅ¼emy uÅ¼yÄ‡ innego kodu, np.: <a href=http://pl.wikipedia.org/wiki/Kod_odpowiedzi_HTTP>403 albo 402</a> ğŸ˜ƒ</p><h2 id=przekierowanie-ciekawskich-w-ciemnÄ…-dupÄ™>Przekierowanie ciekawskich w &ldquo;ciemnÄ… dupÄ™&rdquo;</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#66d9ef>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>^/(wp-)?admin(istrator)?/?</span>  {
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> <span style=color:#e6db74>http://whatismyipaddress.com/ip/</span>$remote_addr <span style=color:#e6db74>redirect</span>;
}
</code></pre></div><p>Ten prosty redirect odwodzi wielu amatorÃ³w zbyt gÅ‚Ä™bokiego penetrowania naszej strony&mldr; A pozostaÅ‚ych na pewno rozbawi ğŸ˜ƒ</p><p>Inne przykÅ‚ady konfiguracji na mojej stronie:</p><ul><li><a href=/2013/01/nginx-hide-server-version-and-name-in-server-header-and-error-pages/>Nginx - hide server version and name in Server header and error pages</a></li><li><a href=/2012/12/nginx-kompresowanie-plikow-dla-gzip_static/>Nginx - kompresowanie plikÃ³w dla gzip_static</a></li><li><a href=/2012/06/nginx-konfiguracja-pod-wordpressa/>Nginx - konfiguracja pod WordPressâ€™a</a></li><li><a href=/2012/06/nginx-ustawienie-domyslnego-vhosta/>Nginx - ustawienie domyÅ›lnego vhosta</a></li><li><a href=/2012/06/nginx-moj-domyslny-config/>Nginx - mÃ³j domyÅ›lny config</a></li></ul><h5 id=ÅºrÃ³dÅ‚a>Å¹rÃ³dÅ‚a</h5><p><a href=http://www.engineyard.com/blog/2011/useful-rewrites-for-nginx/>http://www.engineyard.com/blog/2011/useful-rewrites-for-nginx/</a><br><a href=http://wiki.nginx.org/HttpRewriteModule>http://wiki.nginx.org/HttpRewriteModule</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/howto/>HOWTO</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/linux/>Linux</a>, <a class=tag href=/tags/nginx/>nginx</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/2013/09/tor-generowanie-milszej-nazwy-dla-hidden-service/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>tor: generowanie milszej nazwy dla hidden service</a></div><div class="next-entry sep-before"><a href=/2013/09/raspberry-pi-pierwsze-kroki/><span class=screen-reader-text>Next post: </span>Raspberry Pi: pierwsze kroki<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/tgagor target=_blank rel="noopener me"><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://linkedin.com/in/tgagor target=_blank rel="noopener me"><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://timor.site/index.xml target=_blank rel="noopener me"><span class=screen-reader-text>Open Rss account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2011-2021 TiMoR Licensed under <a rel=license href="https://creativecommons.org/licenses/by-sa/4.0?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-SA 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"></a></p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script></body></html>