<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Nginx - konfiguracja pod WordPress’a | timor's site</title>
<meta name=keywords content="nginx,reverse proxy,Wordpress">
<meta name=description content="To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress&rsquo;a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx&rsquo;a.
Ponieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.">
<meta name=author content>
<link rel=canonical href=https://timor.site/2012/06/nginx-konfiguracja-pod-wordpressa/>
<link crossorigin=anonymous href=/assets/css/stylesheet.3463bda35fd55b9ad6187f681d9b6a97123e084572ffc8e144d794f0d2a914df.css integrity="sha256-NGO9o1/VW5rWGH9oHZtqlxI+CEVy/8jhRNeU8NKpFN8=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://timor.site/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://timor.site/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://timor.site/favicon-32x32.png>
<link rel=apple-touch-icon href=https://timor.site/apple-touch-icon.png>
<link rel=mask-icon href=https://timor.site/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-88996819-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Nginx - konfiguracja pod WordPress’a">
<meta property="og:description" content="To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress&rsquo;a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx&rsquo;a.
Ponieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://timor.site/2012/06/nginx-konfiguracja-pod-wordpressa/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2012-06-29T00:00:00+00:00">
<meta property="article:modified_time" content="2012-06-29T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Nginx - konfiguracja pod WordPress’a">
<meta name=twitter:description content="To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress&rsquo;a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx&rsquo;a.
Ponieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://timor.site/posts/"},{"@type":"ListItem","position":2,"name":"Nginx - konfiguracja pod WordPress’a","item":"https://timor.site/2012/06/nginx-konfiguracja-pod-wordpressa/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx - konfiguracja pod WordPress’a","name":"Nginx - konfiguracja pod WordPress’a","description":"To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress\u0026rsquo;a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx\u0026rsquo;a.\nPonieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.","keywords":["nginx","reverse proxy","Wordpress"],"articleBody":"To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress’a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx’a.\nPonieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.\nDruga sprawa to zwiększony ruch - w takiej konfiguracji już przy kilku osobach równocześnie przeglądających blog, serwerek zwyczajnie nie radził sobie z dynamicznym generowaniem strony.\nPomysł na rozwiązanie problemu z wydajnością polegał na odpaleniu cache’ującego reverse proxy przed właściwą stroną, z krótkim okresem ważności cache’u (max kilka sekund) tak by przy dużym obciążeniu strony serwować głównie z cache’u (tylko co pewien czas ktoś będzie miał niefart i będzie musiał zaczekać na wygenerowanie strony), przy czym komentarze i panel administracyjny działają z pominięciam cache’owania (czyli każdorazowo trafiają przez proxy do aplikacji).\nWażne jednak by osoba wysyłająca komentarz mogła wynik swojego działania zobaczyć od razu na stronie. Ponieważ komentarze wysyłane są metodą HTTP POST to w momencie odebrania takiego połączenia będzie ustawiane ciasteczko dezaktywujące cache dla danego połączenia na kilka sekund (do momentu jego wygaśnięcia).\nPoniżej plik konfiguracyjny, który należy zapisać np. w: /etc/nginx/sites-available/wordpress\n# na początek ustawiamy lokalizację dla cache'u proxy_cache_path /var/cache/nginx/wordpress levels=1:2 keys_zone=WORDPRESS:10m inactive=24h max_size=100m; # nie chcę stronki z www na początku więc cały ruch przekierowują # na stronkę bez www server { listen 10.0.1.2:80; server_name www.example.com; rewrite ^ http://example.com$request_uri? permanent; } # tutaj ma miejsce magia - główny host obsługujący stronkę # to tak na prawdę cache'ujące proxy serwujące okresowo # generowane pliki server { listen 10.0.1.2:80 default; access_log /var/log/nginx/wordpress.access.log; server_name example.com; # ten rewrite przerzuca do panelu admina nawet jeśli  # na końcu nie wpiszemy ukośnika  # bez niego też to działa ale przekierowanie jest przetwarzane  # przez skrypt stronki i działa wolniej  rewrite ^/wp-admin$ /wp-admin/ last; # cache'ujemy tylko odpowiedzi 200 i przez 60s  # (moja stronka nie obsługuje zbyt dużego ruchu i rzadko  # jest modyfikowana - np. przez komentarze - więc 60s jest OK,  # na bardziej aktywnych stronkach można się pokusić o ustawienie  # 1~3s przez co stronka jest praktycznie dynamiczna ale mimo to  # cache zapewni obsługę nawet kilku tys. zapytań na sekundę  proxy_cache_valid 200 60s; # informacje dla backendu na jakiego host się wbijamy  # i z jakiego \"prawdziwego\" IP  proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # możemy ukryć niektóre nagłówki np. by nie podpowiadać  # z jakich pluginów korzystamy w WordPressie  proxy_hide_header X-Powered-By; # kilka ustawień timeout'ów  proxy_connect_timeout 60; proxy_read_timeout 120; proxy_send_timeout 120; # Ważne - poniższa opcja ustawia w jaki sposób generowane są  # nazwy plików w cache'u,  # dodając np. kolejne zmienne możemy zróżnicować cache dla  # pewnych grup użytkowników  proxy_cache_key \"$scheme$request_method$host$request_uri\"; # domyślna lokalizacja  location / { # ustawiamy domyślną wartość zmiennej  set $no_cache \"\"; # If non GET/HEAD, don't cache \u0026 mark user as uncacheable for 1 second via cookie  # jeśli metoda inna niż GET/HEAD to oznacz usera przez cookie jako niecachowanego  # na czas 60s (ustawiany poniżej)  if ($request_method !~ ^(GET|HEAD)$) { set $no_cache \"1\"; } # jeśli zalogowany to nie cache'uj  if ($http_cookie ~* \"comment_author_|wordpress_(?!test_cookie)|wp-postpass_\" ) { set $no_cache \"1\"; } # jeżeli któryś z wcześniejszych warunków jest spełniony  # to ustawiamy cookie, które poinformuje nas by nie cachować  # kolejnych zapytań  # (z powodu \"dziwnego\" zachowania if w nginx'ie ustawienie  # tego bezpośrednio we wcześniejszych warunkach nie działa)  if ($no_cache = \"1\") { add_header Set-Cookie \"_mcnc=1; Max-Age=61; Path=/\"; add_header X-Microcachable \"0\"; } # jeśli cookie jest ustawione to pomijamy cache i serwujemy  # świeżą treść  if ($http_cookie ~* \"_mcnc\") { set $no_cache \"1\"; } # dwie poniższe opcje zapewniają pominięcia cache'owania  # w przypadku gdy wystąpi któryś z wcześniejszych warunków  proxy_no_cache $no_cache; proxy_cache_bypass $no_cache; # Serwujemy cache jeśli strona jest obecnie odświeżana  # lub wystąpi błąd  proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504; # pliki większe niż 1M nie będą cache'owane  proxy_max_temp_file_size 1M; # cache'ujemy tylko odpowiedzi 200 i przez 60s  # (moja stronka nie obsługuje zbyt dużego ruchu i rzadko  # jest modyfikowana - np. przez komentarze - więc 60s jest OK,  # na bardziej aktywnych stronkach można się pokusić o ustawienie  # 1~3s przez co stronka jest praktycznie dynamiczna ale mimo to  # cache zapewni obsługę nawet kilku tys. zapytań na sekundę  proxy_cache_valid 200 60s; # zmieniamy domyślny klucz cache'owania tak by uwzględniał  # naszą zmienną  proxy_cache_key \"$scheme://$host$request_uri $no_cache\"; # wskazujemy konkretną lokalizację cache'u  proxy_cache WORDPRESS; # podajemy lokalizację backendu (nie widziałem sensu  # by udostępniać go na zewnętrznym adresie)  proxy_pass http://127.0.0.1:81; # można ustawić dodatkowo cache'owanie strony w przeglądarce  # (całkiem niezależnie od tego co będzie w cache'u na serwerze)  expires 60s; } # dla panelu administracyjnego ustawiamy proxy bez cache'u  location ~* wp\\-(admin|login) { # dostęp do panelu administracyjnego dodatkowo chronimy  # hasłem - po co?  # bo w tym katalogu są różne fajne skrypty, w których już  # nie raz znaleziono dziury  auth_basic \"Go Away\"; auth_basic_user_file htpasswd; # proxy bez cache'u  proxy_pass http://127.0.0.1:81; } # statykę cache'ujemy mocniej niż treści dynamiczne  # a czemu nie puszczam jej bezpośrednio? bo wyplute przez  # backend zostaną skompresowane i w takiej postaci zachowają  # się w cache'u - gdybym serwował je bezpośrednio to nginx  # kompresowałby np. css'y/js'y przy każdym dostępie do nich  location ~* \\.(jpg|png|gif|jpeg|css|js|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)$ { # cache'ujemy statykę przez 2 godziny  proxy_cache_valid 200 120m; # dodatkowo ustawiamy długie cache'owanie w przeglądarkach  expires 864000; # puszczamy wszystko w proxy + cache  proxy_pass http://127.0.0.1:81; proxy_cache WORDPRESS; # wyłączam logowanie dostępu do statyki nawet w przypadku błędów  # to mało istotne  log_not_found off; access_log off; } # jeszcze inaczej ustawiam cache dla RSS'ów  location ~* \\/[^\\/]+\\/(feed|\\.xml)\\/? { # cache'ujemy RSS'y przez 45 minut  if ($http_cookie ~* \"comment_author_|wordpress_(?!test_cookie)|wp-postpass_\" ) { set $no_cache 1; } proxy_cache_key \"$scheme://$host$request_uri $no_cache\"; proxy_cache_valid 200 45m; proxy_cache MYSITE; proxy_pass http://127.0.0.1:81; } } # to teraz konfiguracja serwera serwującego treści dynamiczne server { # nasłuchujemy lokalnie bo z zewnątrz strona dostępna  # jest przez proxy  listen 127.0.0.1:81; error_log /var/log/nginx/mysite.error.log; root /var/www/wordpress; index index.php; # logujemy prawdziwe IP dzięki odpowiednim nagłówkom  # przesyłanym przez proxy  set_real_ip_from 127.0.0.0/24; real_ip_header X-Real-IP; # tutaj praktycznie klasyka - z tym że zamiast na końcu  # wskazywać index.php robię najpierw kilka rewrite'ów  # np. dla przeniesionych stron, itp  location / { try_files $uri $uri/ @rewrites; } location @rewrites { rewrite /main http://example.com/about/? permanent; rewrite /projekty http://example.com/category/projects/? permanent; rewrite /tag/gd http://example.com? permanent; rewrite /category/hobby http://roman.com? permanent; rewrite ^ /index.php last; } # na bardziej obleganych stronach limitowanie wyszukiwania może # pomóc, ale to nie mój przypadek # location /search { limit_req zone=mysitesearch burst=3 nodelay; rewrite ^ /index.php; }  location ~* \\.(?:ico|css|js|gif|jpe?g|png)$ { # cache'owanie atrybutów statycznych plików  open_file_cache max=1000 inactive=120s; open_file_cache_valid 45s; open_file_cache_min_uses 2; open_file_cache_errors off; # maksymalne cache'owanie statyki w przeglądarkach  expires max; } # no i na końcu obsługa skryptów php  location ~* \\.php$ { # albo plik istnieje i go serwujemy albo dajemy Forbidden  try_files $uri =403; # kilka standardowych ustawień  include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; # blokujemy możliwość wykonywania skryptów z katalogu upload  # (nawet jeśli komuś uda się je wepchnąć)  if ($uri !~ \"^/wp-content/uploads/\") { fastcgi_pass php-fastcgi; } # informacje dla proxy jak długo może cache'ować  add_header Cache-Control \"max-age:60, public\"; expires 60s; } # blokuję dostęp do plików zaczynających się od kropki  location ~ /\\. { access_log off; log_not_found off; deny all; } # wyłączam logowanie do nieistotnych plików  location = /robots.txt { allow all; access_log off; log_not_found off; } location = /favicon.ico { access_log off; log_not_found off; } } Konfiguracja potrzebuje jednego folderu na cache, do którego dostęp do zapisu ma nginx (użytkownik na którym działa proces):\nmkdir -p /var/cache/nginx/wordpress chown -R www-data:www-data /var/cache/nginx/wordpress A żeby zaczął działać trzeba go “włączyć” i przeładować nginx’a:\ncd /etc/nginx/sites-available/ ln -s wordpress /etc/nginx/sites-enabled/wordpress service nginx reload Jedyna rzecz, której brakuje w tym configu to konfiguracja backend’u do PHP’a (u mnie nazwana php-fastcgi) - może kiedyś zrobię HOWTO o konfiguracji NGINX+PHP, ale na tą chwilę zakładam że sobie poradzisz 😃\nBenchmark Sprawdźmy jak to wygląda teraz:\nab -n 1000 -c 10 https://gagor.pl/ This is ApacheBench, Version 2.3 1430300 $ Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/ Licensed to The Apache Software Foundation, http://www.apache.org/ Benchmarking gagor.pl (be patient) Completed 100 requests Completed 200 requests Completed 300 requests Completed 400 requests Completed 500 requests Completed 600 requests Completed 700 requests Completed 800 requests Completed 900 requests Completed 1000 requests Finished 1000 requests Server Software: nginx Server Hostname: gagor.pl Server Port: 80 Document Path: / Document Length: 36263 bytes Concurrency Level: 10 Time taken for tests: 8.716 seconds Complete requests: 1000 Failed requests: 22 (Connect: 0, Receive: 0, Length: 22, Exceptions: 0) Write errors: 0 Total transferred: 36601094 bytes HTML transferred: 36263088 bytes Requests per second: 114.73 [#/sec] (mean) Time per request: 87.159 [ms] (mean) Time per request: 8.716 [ms] (mean, across all concurrent requests) Transfer rate: 4100.91 [Kbytes/sec] received Connection Times (ms) min mean[+/-sd] median max Connect: 1 16 7.1 15 55 Processing: 17 67 97.0 53 789 Waiting: 5 28 55.6 19 456 Total: 37 83 98.0 68 803 Percentage of the requests served within a certain time (ms) 50% 68 66% 74 75% 78 80% 80 90% 87 95% 95 98% 665 99% 755 100% 803 (longest request) Dla mnie bomba 😃\nPomysł na taki rodzaj cache’owania zaczerpnąłem stąd.\n","wordCount":"1559","inLanguage":"en","datePublished":"2012-06-29T00:00:00Z","dateModified":"2012-06-29T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://timor.site/2012/06/nginx-konfiguracja-pod-wordpressa/"},"publisher":{"@type":"Organization","name":"timor's site","logo":{"@type":"ImageObject","url":"https://timor.site/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://timor.site/ accesskey=h title="timor's site (Alt + H)">
<img src=https://timor.site/favicon-72x72.png alt aria-label=logo height=36>timor's site</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://timor.site/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://timor.site/projects/ title=Projects>
<span>Projects</span>
</a>
</li>
<li>
<a href=https://timor.site/archives/ title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://timor.site/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
<li>
<a href=https://timor.site/about/ title=About>
<span>About</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://timor.site/>Home</a>&nbsp;»&nbsp;<a href=https://timor.site/posts/>Posts</a></div>
<h1 class=post-title>
Nginx - konfiguracja pod WordPress’a
</h1>
<div class=post-meta><span title="2012-06-29 00:00:00 +0000 UTC">2012-06-29</span>&nbsp;·&nbsp;8 min
</div>
</header>
<div class=post-content><p>To raczej nie jest podstawowy konfig i próżno szukać go na stronie WordPress&rsquo;a, więc odradzam tę zabawę jeśli nie zna się zbyt dobrze nginx&rsquo;a.</p>
<p>Ponieważ serwerek, na którym działa stronka to sprzęcik z Atomem 330 i mocy na CPU zbyt wiele nie ma to popularne pluginy (np. W3 Total Cache) potencjalnie zwiększające wydajność tak na prawdę zmulały stronkę jeszcze bardziej. Pluginów sprawdziłem kilka i każdorazowo efekt był podobny - stronka działała wolniej niż bez ich pomocy.</p>
<p>Druga sprawa to zwiększony ruch - w takiej konfiguracji już przy kilku osobach równocześnie przeglądających blog, serwerek zwyczajnie nie radził sobie z dynamicznym generowaniem strony.</p>
<p>Pomysł na rozwiązanie problemu z wydajnością polegał na odpaleniu cache&rsquo;ującego reverse proxy przed właściwą stroną, z krótkim okresem ważności cache&rsquo;u (max kilka sekund) tak by przy dużym obciążeniu strony serwować głównie z cache&rsquo;u (tylko co pewien czas ktoś będzie miał niefart i będzie musiał zaczekać na wygenerowanie strony), przy czym komentarze i panel administracyjny działają z pominięciam cache&rsquo;owania (czyli każdorazowo trafiają przez proxy do aplikacji).</p>
<p>Ważne jednak by osoba wysyłająca komentarz mogła wynik swojego działania zobaczyć od razu na stronie. Ponieważ komentarze wysyłane są metodą HTTP POST to w momencie odebrania takiego połączenia będzie ustawiane ciasteczko dezaktywujące cache dla danego połączenia na kilka sekund (do momentu jego wygaśnięcia).</p>
<p>Poniżej plik konfiguracyjny, który należy zapisać np. w: <code>/etc/nginx/sites-available/wordpress</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#75715e># na początek ustawiamy lokalizację dla cache&#39;u
</span><span style=color:#75715e></span><span style=color:#66d9ef>proxy_cache_path</span> <span style=color:#e6db74>/var/cache/nginx/wordpress</span> <span style=color:#e6db74>levels=1:2</span> <span style=color:#e6db74>keys_zone=WORDPRESS:10m</span> <span style=color:#e6db74>inactive=24h</span> <span style=color:#e6db74>max_size=100m</span>;
<span style=color:#75715e># nie chcę stronki z www na początku więc cały ruch przekierowują
</span><span style=color:#75715e># na stronkę bez www
</span><span style=color:#75715e></span><span style=color:#66d9ef>server</span> {
  <span style=color:#f92672>listen</span> 10.0.1.2:<span style=color:#ae81ff>80</span>;
  <span style=color:#f92672>server_name</span> <span style=color:#e6db74>www.example.com</span>;
  <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> <span style=color:#e6db74>http://example.com</span>$request_uri? <span style=color:#e6db74>permanent</span>;
}
<span style=color:#75715e># tutaj ma miejsce magia - główny host obsługujący stronkę
</span><span style=color:#75715e># to tak na prawdę cache&#39;ujące proxy serwujące okresowo
</span><span style=color:#75715e># generowane pliki
</span><span style=color:#75715e></span><span style=color:#66d9ef>server</span> {
  <span style=color:#f92672>listen</span> 10.0.1.2:<span style=color:#ae81ff>80</span> <span style=color:#e6db74>default</span>;
  <span style=color:#f92672>access_log</span> <span style=color:#e6db74>/var/log/nginx/wordpress.access.log</span>;
  <span style=color:#f92672>server_name</span> <span style=color:#e6db74>example.com</span>;

  <span style=color:#75715e># ten rewrite przerzuca do panelu admina nawet jeśli
</span><span style=color:#75715e></span>  <span style=color:#75715e># na końcu nie wpiszemy ukośnika
</span><span style=color:#75715e></span>  <span style=color:#75715e># bez niego też to działa ale przekierowanie jest przetwarzane
</span><span style=color:#75715e></span>  <span style=color:#75715e># przez skrypt stronki i działa wolniej
</span><span style=color:#75715e></span>  <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^/wp-admin</span>$ <span style=color:#e6db74>/wp-admin/</span> <span style=color:#e6db74>last</span>;

  <span style=color:#75715e># cache&#39;ujemy tylko odpowiedzi 200 i przez 60s
</span><span style=color:#75715e></span>  <span style=color:#75715e># (moja stronka nie obsługuje zbyt dużego ruchu i rzadko
</span><span style=color:#75715e></span>  <span style=color:#75715e># jest modyfikowana - np. przez komentarze - więc 60s jest OK,
</span><span style=color:#75715e></span>  <span style=color:#75715e># na bardziej aktywnych stronkach można się pokusić o ustawienie
</span><span style=color:#75715e></span>  <span style=color:#75715e># 1~3s przez co stronka jest praktycznie dynamiczna ale mimo to
</span><span style=color:#75715e></span>  <span style=color:#75715e># cache zapewni obsługę nawet kilku tys. zapytań na sekundę
</span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#e6db74>60s</span>;

  <span style=color:#75715e># informacje dla backendu na jakiego host się wbijamy
</span><span style=color:#75715e></span>  <span style=color:#75715e># i z jakiego &#34;prawdziwego&#34; IP
</span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $http_host;
  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Real-IP</span> $remote_addr;
  <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $proxy_add_x_forwarded_for;

  <span style=color:#75715e># możemy ukryć niektóre nagłówki np. by nie podpowiadać
</span><span style=color:#75715e></span>  <span style=color:#75715e># z jakich pluginów korzystamy w WordPressie
</span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_hide_header</span> <span style=color:#e6db74>X-Powered-By</span>;

  <span style=color:#75715e># kilka ustawień timeout&#39;ów
</span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_connect_timeout</span> <span style=color:#ae81ff>60</span>;
  <span style=color:#f92672>proxy_read_timeout</span> <span style=color:#ae81ff>120</span>;
  <span style=color:#f92672>proxy_send_timeout</span> <span style=color:#ae81ff>120</span>;

  <span style=color:#75715e># Ważne - poniższa opcja ustawia w jaki sposób generowane są
</span><span style=color:#75715e></span>  <span style=color:#75715e># nazwy plików w cache&#39;u,
</span><span style=color:#75715e></span>  <span style=color:#75715e># dodając np. kolejne zmienne możemy zróżnicować cache dla
</span><span style=color:#75715e></span>  <span style=color:#75715e># pewnych grup użytkowników
</span><span style=color:#75715e></span>  <span style=color:#f92672>proxy_cache_key</span> <span style=color:#e6db74>&#34;</span>$scheme$request_method$host$request_uri&#34;;

  <span style=color:#75715e># domyślna lokalizacja
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
    <span style=color:#75715e># ustawiamy domyślną wartość zmiennej
</span><span style=color:#75715e></span>    <span style=color:#f92672>set</span> $no_cache <span style=color:#e6db74>&#34;&#34;</span>;

    <span style=color:#75715e># If non GET/HEAD, don&#39;t cache &amp; mark user as uncacheable for 1 second via cookie
</span><span style=color:#75715e></span>    <span style=color:#75715e># jeśli metoda inna niż GET/HEAD to oznacz usera przez cookie jako niecachowanego
</span><span style=color:#75715e></span>    <span style=color:#75715e># na czas 60s (ustawiany poniżej)
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$request_method <span style=color:#e6db74>!~</span> <span style=color:#e6db74>^(GET|HEAD)</span>$<span style=color:#e6db74>)</span> {
      <span style=color:#f92672>set</span> $no_cache <span style=color:#e6db74>&#34;1&#34;</span>;
    }

    <span style=color:#75715e># jeśli zalogowany to nie cache&#39;uj
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$http_cookie ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>&#34;comment_author_|wordpress_(?!test_cookie)|wp-postpass_&#34;</span> <span style=color:#e6db74>)</span> {
      <span style=color:#f92672>set</span> $no_cache <span style=color:#e6db74>&#34;1&#34;</span>;
    }

    <span style=color:#75715e># jeżeli któryś z wcześniejszych warunków jest spełniony
</span><span style=color:#75715e></span>    <span style=color:#75715e># to ustawiamy cookie, które poinformuje nas by nie cachować
</span><span style=color:#75715e></span>    <span style=color:#75715e># kolejnych zapytań
</span><span style=color:#75715e></span>    <span style=color:#75715e># (z powodu &#34;dziwnego&#34; zachowania if w nginx&#39;ie ustawienie
</span><span style=color:#75715e></span>    <span style=color:#75715e># tego bezpośrednio we wcześniejszych warunkach nie działa)
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$no_cache = <span style=color:#e6db74>&#34;1&#34;)</span> {
      <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Set-Cookie</span> <span style=color:#e6db74>&#34;_mcnc=1</span>; <span style=color:#f92672>Max-Age=61</span>; <span style=color:#f92672>Path=/&#34;</span>;
      <span style=color:#f92672>add_header</span> <span style=color:#e6db74>X-Microcachable</span> <span style=color:#e6db74>&#34;0&#34;</span>;
    }

    <span style=color:#75715e># jeśli cookie jest ustawione to pomijamy cache i serwujemy
</span><span style=color:#75715e></span>    <span style=color:#75715e># świeżą treść
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$http_cookie ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>&#34;_mcnc&#34;)</span> {
      <span style=color:#f92672>set</span> $no_cache <span style=color:#e6db74>&#34;1&#34;</span>;
    }

    <span style=color:#75715e># dwie poniższe opcje zapewniają pominięcia cache&#39;owania
</span><span style=color:#75715e></span>    <span style=color:#75715e># w przypadku gdy wystąpi któryś z wcześniejszych warunków
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_no_cache</span> $no_cache;
    <span style=color:#f92672>proxy_cache_bypass</span> $no_cache;

    <span style=color:#75715e># Serwujemy cache jeśli strona jest obecnie odświeżana
</span><span style=color:#75715e></span>    <span style=color:#75715e># lub wystąpi błąd
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache_use_stale</span> <span style=color:#e6db74>error</span> <span style=color:#e6db74>timeout</span> <span style=color:#e6db74>invalid_header</span> <span style=color:#e6db74>updating</span>
        <span style=color:#e6db74>http_500</span> <span style=color:#e6db74>http_502</span> <span style=color:#e6db74>http_503</span> <span style=color:#e6db74>http_504</span>;

    <span style=color:#75715e># pliki większe niż 1M nie będą cache&#39;owane
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_max_temp_file_size</span> <span style=color:#e6db74>1M</span>;
    <span style=color:#75715e># cache&#39;ujemy tylko odpowiedzi 200 i przez 60s
</span><span style=color:#75715e></span>    <span style=color:#75715e># (moja stronka nie obsługuje zbyt dużego ruchu i rzadko
</span><span style=color:#75715e></span>    <span style=color:#75715e># jest modyfikowana - np. przez komentarze - więc 60s jest OK,
</span><span style=color:#75715e></span>    <span style=color:#75715e># na bardziej aktywnych stronkach można się pokusić o ustawienie
</span><span style=color:#75715e></span>    <span style=color:#75715e># 1~3s przez co stronka jest praktycznie dynamiczna ale mimo to
</span><span style=color:#75715e></span>    <span style=color:#75715e># cache zapewni obsługę nawet kilku tys. zapytań na sekundę
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#e6db74>60s</span>;
    <span style=color:#75715e># zmieniamy domyślny klucz cache&#39;owania tak by uwzględniał
</span><span style=color:#75715e></span>    <span style=color:#75715e># naszą zmienną
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache_key</span> <span style=color:#e6db74>&#34;</span>$scheme://$host$request_uri $no_cache&#34;;

    <span style=color:#75715e># wskazujemy konkretną lokalizację cache&#39;u
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>WORDPRESS</span>;
    <span style=color:#75715e># podajemy lokalizację backendu (nie widziałem sensu
</span><span style=color:#75715e></span>    <span style=color:#75715e># by udostępniać go na zewnętrznym adresie)
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:81</span>;

    <span style=color:#75715e># można ustawić dodatkowo cache&#39;owanie strony w przeglądarce
</span><span style=color:#75715e></span>    <span style=color:#75715e># (całkiem niezależnie od tego co będzie w cache&#39;u na serwerze)
</span><span style=color:#75715e></span>    <span style=color:#f92672>expires</span> <span style=color:#e6db74>60s</span>;
  }

  <span style=color:#75715e># dla panelu administracyjnego ustawiamy proxy bez cache&#39;u
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>wp\-(admin|login)</span> {
    <span style=color:#75715e># dostęp do panelu administracyjnego dodatkowo chronimy
</span><span style=color:#75715e></span>    <span style=color:#75715e># hasłem - po co?
</span><span style=color:#75715e></span>    <span style=color:#75715e># bo w tym katalogu są różne fajne skrypty, w których już
</span><span style=color:#75715e></span>    <span style=color:#75715e># nie raz znaleziono dziury
</span><span style=color:#75715e></span>    <span style=color:#f92672>auth_basic</span> <span style=color:#e6db74>&#34;Go</span> <span style=color:#e6db74>Away&#34;</span>;
    <span style=color:#f92672>auth_basic_user_file</span> <span style=color:#e6db74>htpasswd</span>;

    <span style=color:#75715e># proxy bez cache&#39;u
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:81</span>;
  }

  <span style=color:#75715e># statykę cache&#39;ujemy mocniej niż treści dynamiczne
</span><span style=color:#75715e></span>  <span style=color:#75715e># a czemu nie puszczam jej bezpośrednio? bo wyplute przez
</span><span style=color:#75715e></span>  <span style=color:#75715e># backend zostaną skompresowane i w takiej postaci zachowają
</span><span style=color:#75715e></span>  <span style=color:#75715e># się w cache&#39;u - gdybym serwował je bezpośrednio to nginx
</span><span style=color:#75715e></span>  <span style=color:#75715e># kompresowałby np. css&#39;y/js&#39;y przy każdym dostępie do nich
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.(jpg|png|gif|jpeg|css|js|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)</span>$ {
    <span style=color:#75715e># cache&#39;ujemy statykę przez 2 godziny
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>120m</span>;
    <span style=color:#75715e># dodatkowo ustawiamy długie cache&#39;owanie w przeglądarkach
</span><span style=color:#75715e></span>    <span style=color:#f92672>expires</span> <span style=color:#ae81ff>864000</span>;

    <span style=color:#75715e># puszczamy wszystko w proxy + cache
</span><span style=color:#75715e></span>    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:81</span>;
    <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>WORDPRESS</span>;

    <span style=color:#75715e># wyłączam logowanie dostępu do statyki nawet w przypadku błędów
</span><span style=color:#75715e></span>    <span style=color:#75715e># to mało istotne
</span><span style=color:#75715e></span>    <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>;
    <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>;
  }
  <span style=color:#75715e># jeszcze inaczej ustawiam cache dla RSS&#39;ów
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\/[^\/]+\/(feed|\.xml)\/?</span> {
    <span style=color:#75715e># cache&#39;ujemy RSS&#39;y przez 45 minut
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$http_cookie ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>&#34;comment_author_|wordpress_(?!test_cookie)|wp-postpass_&#34;</span> <span style=color:#e6db74>)</span> {
      <span style=color:#f92672>set</span> $no_cache <span style=color:#ae81ff>1</span>;
    }

    <span style=color:#f92672>proxy_cache_key</span> <span style=color:#e6db74>&#34;</span>$scheme://$host$request_uri $no_cache&#34;;
    <span style=color:#f92672>proxy_cache_valid</span> <span style=color:#ae81ff>200</span> <span style=color:#ae81ff>45m</span>;
    <span style=color:#f92672>proxy_cache</span> <span style=color:#e6db74>MYSITE</span>;
    <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:81</span>;
  }
}
<span style=color:#75715e># to teraz konfiguracja serwera serwującego treści dynamiczne
</span><span style=color:#75715e></span><span style=color:#66d9ef>server</span> {
  <span style=color:#75715e># nasłuchujemy lokalnie bo z zewnątrz strona dostępna
</span><span style=color:#75715e></span>  <span style=color:#75715e># jest przez proxy
</span><span style=color:#75715e></span>  <span style=color:#f92672>listen</span> 127.0.0.1:<span style=color:#ae81ff>81</span>;
  <span style=color:#f92672>error_log</span> <span style=color:#e6db74>/var/log/nginx/mysite.error.log</span>;

  <span style=color:#f92672>root</span> <span style=color:#e6db74>/var/www/wordpress</span>;
  <span style=color:#f92672>index</span> <span style=color:#e6db74>index.php</span>;

  <span style=color:#75715e># logujemy prawdziwe IP dzięki odpowiednim nagłówkom
</span><span style=color:#75715e></span>  <span style=color:#75715e># przesyłanym przez proxy
</span><span style=color:#75715e></span>  <span style=color:#f92672>set_real_ip_from</span> <span style=color:#ae81ff>127</span><span style=color:#e6db74>.0.0.0/24</span>;
  <span style=color:#f92672>real_ip_header</span> <span style=color:#e6db74>X-Real-IP</span>;

  <span style=color:#75715e># tutaj praktycznie klasyka - z tym że zamiast na końcu
</span><span style=color:#75715e></span>  <span style=color:#75715e># wskazywać index.php robię najpierw kilka rewrite&#39;ów
</span><span style=color:#75715e></span>  <span style=color:#75715e># np. dla przeniesionych stron, itp
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
    <span style=color:#f92672>try_files</span> $uri $uri/ <span style=color:#e6db74>@rewrites</span>;
  }

  <span style=color:#f92672>location</span> <span style=color:#e6db74>@rewrites</span> {
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/main</span>           <span style=color:#e6db74>http://example.com/about/?</span> <span style=color:#e6db74>permanent</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/projekty</span>       <span style=color:#e6db74>http://example.com/category/projects/?</span> <span style=color:#e6db74>permanent</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/tag/gd</span>         <span style=color:#e6db74>http://example.com?</span> <span style=color:#e6db74>permanent</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>/category/hobby</span> <span style=color:#e6db74>http://roman.com?</span> <span style=color:#e6db74>permanent</span>;
    <span style=color:#f92672>rewrite</span> <span style=color:#e6db74>^</span> <span style=color:#e6db74>/index.php</span> <span style=color:#e6db74>last</span>;
  }

<span style=color:#75715e># na bardziej obleganych stronach limitowanie wyszukiwania może
</span><span style=color:#75715e># pomóc, ale to nie mój przypadek
</span><span style=color:#75715e># location /search { limit_req zone=mysitesearch burst=3 nodelay; rewrite ^ /index.php; }
</span><span style=color:#75715e></span>
  <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.(?:ico|css|js|gif|jpe?g|png)</span>$ {
    <span style=color:#75715e># cache&#39;owanie atrybutów statycznych plików
</span><span style=color:#75715e></span>    <span style=color:#f92672>open_file_cache</span> <span style=color:#e6db74>max=1000</span> <span style=color:#e6db74>inactive=120s</span>;
    <span style=color:#f92672>open_file_cache_valid</span> <span style=color:#e6db74>45s</span>;
    <span style=color:#f92672>open_file_cache_min_uses</span> <span style=color:#ae81ff>2</span>;
    <span style=color:#f92672>open_file_cache_errors</span> <span style=color:#66d9ef>off</span>;
    <span style=color:#75715e># maksymalne cache&#39;owanie statyki w przeglądarkach
</span><span style=color:#75715e></span>    <span style=color:#f92672>expires</span> <span style=color:#e6db74>max</span>;
  }

  <span style=color:#75715e># no i na końcu obsługa skryptów php
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> ~<span style=color:#e6db74>*</span> <span style=color:#e6db74>\.php</span>$ {
    <span style=color:#75715e># albo plik istnieje i go serwujemy albo dajemy Forbidden
</span><span style=color:#75715e></span>    <span style=color:#f92672>try_files</span> $uri =<span style=color:#ae81ff>403</span>;

    <span style=color:#75715e># kilka standardowych ustawień
</span><span style=color:#75715e></span>    <span style=color:#f92672>include</span> <span style=color:#e6db74>fastcgi_params</span>;
    <span style=color:#f92672>fastcgi_param</span> <span style=color:#e6db74>SCRIPT_FILENAME</span> $document_root$fastcgi_script_name;
    <span style=color:#75715e># blokujemy możliwość wykonywania skryptów z katalogu upload
</span><span style=color:#75715e></span>    <span style=color:#75715e># (nawet jeśli komuś uda się je wepchnąć)
</span><span style=color:#75715e></span>    <span style=color:#f92672>if</span> <span style=color:#e6db74>(</span>$uri <span style=color:#e6db74>!~</span> <span style=color:#e6db74>&#34;^/wp-content/uploads/&#34;)</span> {
      <span style=color:#f92672>fastcgi_pass</span> <span style=color:#e6db74>php-fastcgi</span>;
    }

    <span style=color:#75715e># informacje dla proxy jak długo może cache&#39;ować
</span><span style=color:#75715e></span>    <span style=color:#f92672>add_header</span> <span style=color:#e6db74>Cache-Control</span> <span style=color:#e6db74>&#34;max-age:60,</span> <span style=color:#e6db74>public&#34;</span>;
    <span style=color:#f92672>expires</span> <span style=color:#e6db74>60s</span>;
  }

  <span style=color:#75715e># blokuję dostęp do plików zaczynających się od kropki
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> ~ <span style=color:#e6db74>/\.</span> { <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>deny</span> <span style=color:#e6db74>all</span>; }

  <span style=color:#75715e># wyłączam logowanie do nieistotnych plików
</span><span style=color:#75715e></span>  <span style=color:#f92672>location</span> = <span style=color:#e6db74>/robots.txt</span> { <span style=color:#f92672>allow</span> <span style=color:#e6db74>all</span>; <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; }
  <span style=color:#f92672>location</span> = <span style=color:#e6db74>/favicon.ico</span> { <span style=color:#f92672>access_log</span> <span style=color:#66d9ef>off</span>; <span style=color:#f92672>log_not_found</span> <span style=color:#66d9ef>off</span>; }
}
</code></pre></div><p>Konfiguracja potrzebuje jednego folderu na cache, do którego dostęp do zapisu ma nginx (użytkownik na którym działa proces):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p /var/cache/nginx/wordpress
chown -R www-data:www-data /var/cache/nginx/wordpress
</code></pre></div><p>A żeby zaczął działać trzeba go &ldquo;włączyć&rdquo; i przeładować nginx&rsquo;a:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /etc/nginx/sites-available/
ln -s wordpress /etc/nginx/sites-enabled/wordpress
service nginx reload
</code></pre></div><p>Jedyna rzecz, której brakuje w tym configu to konfiguracja backend&rsquo;u do PHP&rsquo;a (u mnie nazwana php-fastcgi) - może kiedyś zrobię HOWTO o konfiguracji NGINX+PHP, ale na tą chwilę zakładam że sobie poradzisz 😃</p>
<h2 id=benchmark>Benchmark<a hidden class=anchor aria-hidden=true href=#benchmark>#</a></h2>
<p>Sprawdźmy jak to wygląda teraz:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ab -n <span style=color:#ae81ff>1000</span> -c <span style=color:#ae81ff>10</span> https://gagor.pl/
This is ApacheBench, Version 2.3 &lt; $Revision: <span style=color:#ae81ff>1430300</span> $&gt;
Copyright <span style=color:#ae81ff>1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking gagor.pl <span style=color:#f92672>(</span>be patient<span style=color:#f92672>)</span>
Completed <span style=color:#ae81ff>100</span> requests
Completed <span style=color:#ae81ff>200</span> requests
Completed <span style=color:#ae81ff>300</span> requests
Completed <span style=color:#ae81ff>400</span> requests
Completed <span style=color:#ae81ff>500</span> requests
Completed <span style=color:#ae81ff>600</span> requests
Completed <span style=color:#ae81ff>700</span> requests
Completed <span style=color:#ae81ff>800</span> requests
Completed <span style=color:#ae81ff>900</span> requests
Completed <span style=color:#ae81ff>1000</span> requests
Finished <span style=color:#ae81ff>1000</span> requests


Server Software:        nginx
Server Hostname:        gagor.pl
Server Port:            <span style=color:#ae81ff>80</span>

Document Path:          /
Document Length:        <span style=color:#ae81ff>36263</span> bytes

Concurrency Level:      <span style=color:#ae81ff>10</span>
Time taken <span style=color:#66d9ef>for</span> tests:   8.716 seconds
Complete requests:      <span style=color:#ae81ff>1000</span>
Failed requests:        <span style=color:#ae81ff>22</span>
   <span style=color:#f92672>(</span>Connect: 0, Receive: 0, Length: 22, Exceptions: 0<span style=color:#f92672>)</span>
Write errors:           <span style=color:#ae81ff>0</span>
Total transferred:      <span style=color:#ae81ff>36601094</span> bytes
HTML transferred:       <span style=color:#ae81ff>36263088</span> bytes
Requests per second:    114.73 <span style=color:#f92672>[</span><span style=color:#75715e>#/sec] (mean)</span>
Time per request:       87.159 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean<span style=color:#f92672>)</span>
Time per request:       8.716 <span style=color:#f92672>[</span>ms<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>mean, across all concurrent requests<span style=color:#f92672>)</span>
Transfer rate:          4100.91 <span style=color:#f92672>[</span>Kbytes/sec<span style=color:#f92672>]</span> received

Connection Times <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
              min  mean<span style=color:#f92672>[</span>+/-sd<span style=color:#f92672>]</span> median   max
Connect:        <span style=color:#ae81ff>1</span>   <span style=color:#ae81ff>16</span>   7.1     <span style=color:#ae81ff>15</span>      <span style=color:#ae81ff>55</span>
Processing:    <span style=color:#ae81ff>17</span>   <span style=color:#ae81ff>67</span>  97.0     <span style=color:#ae81ff>53</span>     <span style=color:#ae81ff>789</span>
Waiting:        <span style=color:#ae81ff>5</span>   <span style=color:#ae81ff>28</span>  55.6     <span style=color:#ae81ff>19</span>     <span style=color:#ae81ff>456</span>
Total:         <span style=color:#ae81ff>37</span>   <span style=color:#ae81ff>83</span>  98.0     <span style=color:#ae81ff>68</span>     <span style=color:#ae81ff>803</span>

Percentage of the requests served within a certain time <span style=color:#f92672>(</span>ms<span style=color:#f92672>)</span>
  50%     <span style=color:#ae81ff>68</span>
  66%     <span style=color:#ae81ff>74</span>
  75%     <span style=color:#ae81ff>78</span>
  80%     <span style=color:#ae81ff>80</span>
  90%     <span style=color:#ae81ff>87</span>
  95%     <span style=color:#ae81ff>95</span>
  98%    <span style=color:#ae81ff>665</span>
  99%    <span style=color:#ae81ff>755</span>
 100%    <span style=color:#ae81ff>803</span> <span style=color:#f92672>(</span>longest request<span style=color:#f92672>)</span>
</code></pre></div><p>Dla mnie bomba 😃</p>
<p>Pomysł na taki rodzaj cache&rsquo;owania zaczerpnąłem <a href=http://fennb.com/microcaching-speed-your-app-up-250x-with-no-n>stąd</a>.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://timor.site/tags/nginx/>nginx</a></li>
<li><a href=https://timor.site/tags/reverse-proxy/>reverse proxy</a></li>
<li><a href=https://timor.site/tags/wordpress/>Wordpress</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://timor.site/2012/08/przeszukiwanie-plikow-danego-typu-pod-katem-tekstu/>
<span class=title>« Prev</span>
<br>
<span>Przeszukiwanie plików danego typu pod kątem tekstu</span>
</a>
<a class=next href=https://timor.site/2012/06/xen-podstawowe-polecenia/>
<span class=title>Next »</span>
<br>
<span>Xen - Podstawowe polecenia</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on twitter" href="https://twitter.com/intent/tweet/?text=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a&url=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f&hashtags=nginx%2creverseproxy%2cWordpress"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f&title=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a&summary=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a&source=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f&title=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on whatsapp" href="https://api.whatsapp.com/send?text=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a%20-%20https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Nginx - konfiguracja pod WordPress’a on telegram" href="https://telegram.me/share/url?text=Nginx%20-%20konfiguracja%20pod%20WordPress%e2%80%99a&url=https%3a%2f%2ftimor.site%2f2012%2f06%2fnginx-konfiguracja-pod-wordpressa%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer><div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//gagor-pl.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</article>
</main>
<footer class=footer>
<span><a href=https://timor.site/>timor's site</a> &copy; 2008-2022</span>
<span>Content licensed under <a rel="license noopener noreferrer" target=_blank href=http://creativecommons.org/licenses/by-sa/4.0/>(CC BY-SA 4.0)</a></span>
</footer>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>