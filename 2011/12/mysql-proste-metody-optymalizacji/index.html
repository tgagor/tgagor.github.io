<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Wcześniej czy później zawsze pojawia się potrzeba zoptymalizowania naszej bazy MySQL. Przedstawię kilka zmian w konfiguracji, które powinny zwiększyć wydajność w większości przypadków.
MyISAM - key_buffer_size Najprostszą optymalizacją baz/tabel z mechanizmem MyISAM jest odpowiednie dobranie bufora na cache dla kluczy i indeksów (dane nigdy nie są cachowane). Poniższe zapytanie pozwala oszacować zalecany rozmiar cache&rsquo;u:
SELECT CONCAT(ROUND(KBS/POWER(1024, IF(PowerOf1024<0,0,IF(PowerOf1024>3,0,PowerOf1024)))+0.4999), SUBSTR(' KMG',IF(PowerOf1024<0,0, IF(PowerOf1024>3,0,PowerOf1024))+1,1)) recommended_key_buffer_size FROM (SELECT LEAST(POWER(2,32),KBS1) KBS FROM (SELECT SUM(index_length) KBS1 FROM information_schema."><meta name=theme-color content="#c64858"><meta property="og:title" content="MySQL - Proste metody optymalizacji • TiMoR"><meta property="og:description" content="Wcześniej czy później zawsze pojawia się potrzeba zoptymalizowania naszej bazy MySQL. Przedstawię kilka zmian w konfiguracji, które powinny zwiększyć wydajność w większości przypadków.
MyISAM - key_buffer_size Najprostszą optymalizacją baz/tabel z mechanizmem MyISAM jest odpowiednie dobranie bufora na cache dla kluczy i indeksów (dane nigdy nie są cachowane). Poniższe zapytanie pozwala oszacować zalecany rozmiar cache&rsquo;u:
SELECT CONCAT(ROUND(KBS/POWER(1024, IF(PowerOf1024<0,0,IF(PowerOf1024>3,0,PowerOf1024)))+0.4999), SUBSTR(' KMG',IF(PowerOf1024<0,0, IF(PowerOf1024>3,0,PowerOf1024))+1,1)) recommended_key_buffer_size FROM (SELECT LEAST(POWER(2,32),KBS1) KBS FROM (SELECT SUM(index_length) KBS1 FROM information_schema."><meta property="og:url" content="https://timor.site/2011/12/mysql-proste-metody-optymalizacji/"><meta property="og:site_name" content="timor's site"><meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/cfa9a17577371083824a78c303cc8ed7?s=256"><meta property="article:section" content="posts"><meta property="article:tag" content="MariaDB"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="Percona"><meta property="article:published_time" content="2011-12-29T00:00:00Z"><meta property="article:modified_time" content="2011-12-29T00:00:00Z"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.76.5"><title>MySQL - Proste metody optymalizacji • TiMoR</title><link rel=canonical href=https://timor.site/2011/12/mysql-proste-metody-optymalizacji/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.ab98e12b.css><style>:root{--color-accent:#c64858}</style><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-88996819-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="page type-posts layout-post has-sidebar"><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu>Skip to Main Menu</a><div class=container><section class="widget widget-about sep-after"><header><div class=logo><a href=/><img src=/favicon.ico></a></div><h2 class="title site-title"><a href=/>timor's site</a></h2><div class=desc>Linux configuration, Automation, Security - Sysadmin/DevOps blog</div></header></section><section class="widget widget-search sep-after"><header><h4 class="title widget-title">Search</h4></header><form action=/search id=search-form class=search-form><label><span class=screen-reader-text>Search</span>
<input id=search-term class=search-term type=search name=q placeholder=Search&mldr;></label></form></section><section class="widget widget-sidebar_menu sep-after"><nav id=sidebar-menu class="menu sidebar-menu" aria-label="Sidebar Menu"><div class=container><ul><li class=item><a href=/></a></li><li class=item><a href=/>Home</a></li><li class="item has-children"><a href=/categories/howto/>HOWTO</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span></button><ul class=sub-menu><li class=item><a href=/categories/tip/>Tips</a></li></ul></li><li class=item><a href=/categories/off-topic/>Off-topic</a></li><li class=item><a href=/categories/gotowanie/>Gotowanie</a></li><li class=item><a href=/about/>About</a></li></ul></div></nav></section></div><div class=sidebar-overlay></div></div><div class=main><a class=screen-reader-text href=#content>Skip to Content</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><div class=header-widgets><div class=container><style>.widget-breadcrumbs li:after{content:'\2f '}</style><section class="widget widget-breadcrumbs sep-after"><nav id=breadcrumbs><ol><li><a href=/>Home</a></li><li><a href=/posts/>Posts</a></li><li><span>MySQL - Proste metody optymalizacji</span></li></ol></nav></section></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">timor's site</p><p class="desc site-desc">Linux configuration, Automation, Security - Sysadmin/DevOps blog</p></div></div></header><main id=content><article lang=en class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>MySQL - Proste metody optymalizacji</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text>Posted on</span>
<time class=entry-date datetime=2011-12-29T00:00:00Z>2011-12-29</time></span>
<span class=byline><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M21 21V20c0-2.76-4-5-9-5s-9 2.24-9 5v1"/><path d="M16 6.37A4 4 0 1112.63 3 4 4 0 0116 6.37z"/></svg><span class=screen-reader-text>by </span><a href=/authors/timor>TiMoR</a></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>5 mins read</span></div></div></header><div class="container entry-content"><p>Wcześniej czy później zawsze pojawia się potrzeba zoptymalizowania naszej bazy MySQL. Przedstawię kilka zmian w konfiguracji, które powinny zwiększyć wydajność w większości przypadków.</p><h2 id=myisam--key_buffer_size>MyISAM - key_buffer_size</h2><p>Najprostszą optymalizacją baz/tabel z mechanizmem MyISAM jest odpowiednie dobranie bufora na cache dla kluczy i indeksów (dane nigdy nie są cachowane). Poniższe zapytanie pozwala oszacować zalecany rozmiar cache&rsquo;u:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> CONCAT(ROUND(KBS<span style=color:#f92672>/</span>POWER(<span style=color:#ae81ff>1024</span>,
<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024)))<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>4999</span>),
SUBSTR(<span style=color:#e6db74>&#39; KMG&#39;</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,
<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024))<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>))
recommended_key_buffer_size <span style=color:#66d9ef>FROM</span>
(<span style=color:#66d9ef>SELECT</span> LEAST(POWER(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>32</span>),KBS1) KBS
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(index_length) KBS1
<span style=color:#66d9ef>FROM</span> information_schema.tables
<span style=color:#66d9ef>WHERE</span> engine<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;MyISAM&#39;</span> <span style=color:#66d9ef>AND</span>
table_schema <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>IN</span> (<span style=color:#e6db74>&#39;information_schema&#39;</span>,<span style=color:#e6db74>&#39;mysql&#39;</span>)) AA ) A,
(<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>2</span> PowerOf1024) B;
</code></pre></div><p>Wynik określa zalecany rozmiar bufora (parametr <em><strong>key_buffer_size</strong></em> w pliku <em>/etc/mysql/my.cnf</em>) dla bieżącego stanu bazy - warto ciut dodać na zapas. Na systemach 32 bitowych parametr <em><strong>key_buffer_size</strong></em> może przyjmować maksymalnie 4GB, na 64 bitowych maksymalnie 8GB.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[mysqld]
key_buffer_size=xxxM
</code></pre></div><h2 id=innodb--innodb_buffer_pool_size>InnoDB - innodb_buffer_pool_size</h2><p>W przypadku InnoDB cachowane mogą być zarówno dane jak i klucze/indeksy a rozmiar bufora określa parametr <em><strong>innodb_buffer_pool_size</strong></em>. Zalecaną minimalną wartość tego parametru możemy oszacować zapytaniem:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> CONCAT(ROUND(KBS<span style=color:#f92672>/</span>POWER(<span style=color:#ae81ff>1024</span>,
<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024)))<span style=color:#f92672>+</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>49999</span>),
SUBSTR(<span style=color:#e6db74>&#39; KMG&#39;</span>,<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>,
<span style=color:#66d9ef>IF</span>(PowerOf1024<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>0</span>,PowerOf1024))<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>1</span>)) recommended_innodb_buffer_pool_size
<span style=color:#66d9ef>FROM</span> (<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(data_length<span style=color:#f92672>+</span>index_length) KBS <span style=color:#66d9ef>FROM</span> information_schema.tables
<span style=color:#66d9ef>WHERE</span> engine<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;InnoDB&#39;</span>) A,
(<span style=color:#66d9ef>SELECT</span> <span style=color:#ae81ff>2</span> PowerOf1024) B;
</code></pre></div><p>W przypadku InnoDB po zmianie wartości <em><strong>innodb_buffer_pool_size</strong></em> konieczne jest również ustawienie <em><strong>innodb_log_file_size</strong></em> na 25% wartości <em><strong>innodb_buffer_pool_size</strong></em> lub 2047M (należy wybrać mniejszą z wartości). By wygenerować pliki log o nowych rozmiarach musimy postępować według poniższej instrukcji:</p><ul><li>Dopisujemy w pliku my.cnf parametry:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[mysqld]
innodb_buffer_pool_size=xxxM
innodb_log_file_size=25% xxxM lub 2047M
</code></pre></div></li><li>Wyłączamy bazę:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>invoke-rc.d mysql stop
</code></pre></div></li><li>Kasujemy obecnie pliki log:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rm /var/lib/mysql/ib_logfile<span style=color:#f92672>[</span>01<span style=color:#f92672>]</span>
</code></pre></div></li><li>Uruchamiamy bazę:<div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>invoke-rc.d mysql start
</code></pre></div></li><li>Po starcie bazy zostaną wygenerowane nowe pliki log o nowych rozmiarach.</li></ul><h2 id=innodb---kompaktowanie-plików>InnoDB - kompaktowanie plików</h2><p>W domyślnej konfiguracji MySQL dla baz InnoDB (na Debianie na bank, przypuszczam że na innych distro jest podobnie) wszystkie tabele, indeksy, metadane tabel i inne dane dotyczące table InnoDB przechowywane są w jednym pliku: <em>/var/lib/mysql/ibdata1</em></p><p>Nie jest to optymalne ustawienie szczególnie gdy mamy dużo baz i o znacznych rozmiarach - wykonywanie wielu równoczesnych operacji na jednym gigantycznym pliku potrafi mocno przymulić.</p><p>Próba kompaktowania/optymalizowania tabel InnoDB nie powoduje zmniejszenia tego pliku - bo gdy próbujemy optymalizować tabele InnoDB powoduje to:</p><ul><li>ułożenie danych i indeksów wewnątrz pliku ibdata1 w sposób ciągły,</li><li>wzrost rozmiaru pliku ibdata1 ponieważ powyższe dane dopisywane są na jego końcu.</li></ul><p>Niewiele osób spodziewa się takiego rezultatu. Można zmniejszyć rozmiar tego pliku wyłączając dane tabel i ich indeksy do osobnych plików ale proces ten wymaga pełnego backupu bazy i jej odtworzenia, wiąże się więc z chwilowym (a w przypadku dużych baz - dłuższym) przestojem.</p><ol><li>Robimy pełny backup bazy, np. poleceniem:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>mysqldump --all-databases --single-transaction -uroot -p &gt; my-dump.sql
</code></pre></div><p>(dump&rsquo;a można dodatkowo skompresować gzipem dodając pipe&rsquo;a - przyspieszy to odzyskiwanie przez zmniejszenie ilości danych potrzebnych do odczytania z dysku)</li></p><ol start=2><li><p>Kasujemy wszystkie bazy z wyjątkiem schematu mysql (de facto powinno wystarczyć skasowanie i odzyskanie tylko baz korzystających z tabel InnoDB)</p></li><li><p>Wyłączamy usługę:</p></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>invoke-rc.d mysql stop
</code></pre></div><ol start=4><li>Dodajemy w pliku <code>/etc/mysql/my.cnf</code> parametry:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[mysqld]
innodb_file_per_table
innodb_log_file_size=25% xG
innodb_buffer_pool_size=xG
</code></pre></div><ul><li>pierwsza opcja powoduje właściwe rozdzielenie tabel InnoDB do różnych plików (dodanie tej opcji na serwerze na którym znajdują się bazy InnoDB spowoduje ich uszkodzenie - odradzam),</li><li>drugą i trzecią linijkę konfigurujemy według wcześniejszej instrukcji o <code>innodb_buffer_pool_size</code>,</li><li>możemy też na czas przywracania danych dodać opcję <code>bulk_insert_buffer_size=256M</code>, skróci to czas potrzebny na przywrócenie bazy.</li></ul><ol start=5><li>Kasujemy pliki: <code>ibdata1</code>, <code>ib_logfile0</code> and <code>ib_logfile1</code>:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rm /var/lib/mysql/ibdata1
rm /var/lib/mysql/ib_logfile<span style=color:#f92672>[</span>01<span style=color:#f92672>]</span>
</code></pre></div><ol start=6><li>Uruchamiamy serwer MySQL:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>invoke-rc.d mysql start
</code></pre></div><ol start=7><li>Przywracamy wszystkie bazy z dump&rsquo;a:</li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat my-dump.sql | mysql -uroot -p
</code></pre></div><p>Plik ibdata1 urośnie ale od tej pory będzie zawierać wyłącznie metadane tabel a poszczególne tabele i indeksy będą przechowywane w osobnych plikach, np. tabela.ibd. Teraz optymalizowanie tabel InnoDB będzie powodować zmniejszenie rozmiarów plików *.ibd a plik ibdata1 nie będzie tak obciążony.</p><h2 id=zmiana-metody-flusha>Zmiana metody flush&rsquo;a</h2><p>W niektórych przypadkach ustawienie opcji <em><strong>innodb_flush_method</strong></em> na wartość <em><strong>O_DIRECT</strong></em> może poprawić wydajność, choć w innych wydajność może się pogorszyć (na forach sugerowano występowanie problemu na dedykowanych macierzach). Można bezpiecznie włączyć tę opcję i wykonać kilka bechmarków:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>[mysqld]
innodb_flush_method=O_DIRECT
</code></pre></div><h2 id=cache-wyników-zapytań>Cache wyników zapytań</h2><p>Sprawdźmy najpierw czy cachowanie jest włączone (u mnie było to domyślne ustawienie), wydajemy zapytanie:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SHOW</span> VARIABLES <span style=color:#66d9ef>LIKE</span> <span style=color:#e6db74>&#39;query_cache_type&#39;</span>;
</code></pre></div><p>Możliwe są 3 ustawienia:</p><ul><li>ON (<code>query_cache_type = 1</code>) - cachowanie wszystkich zapytań,</li><li>OFF (<code>query_cache_type = 0</code>) - cachowanie na żądanie,</li><li>DEMAND (<code>query_cache_type = 2</code>) - cachowanie wyłączone.</li></ul><p>W przypadku opcji DEMAND cachowanie jest włączane jeżeli po SELECT&rsquo;cie dodamy SQL_CACHE. Mi osobiście najbardziej odpowiada opcja z cachowaniem wszystkiego.</p><p>Następnie należy ustawić w pliku my.cnf poniższe zmienne według potrzeb:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>query_cache_limit = 2M
query_cache_size = 32M
</code></pre></div><p>Pierwsza opcja ustala maksymalny rozmiar pojedynczego zapytanie, które będzie cachowane - zapytania większe nie będą cachowane. Druga opcja ustala rozmiar całego bufora na cache (przeważnie więcej działa lepiej).</p><h2 id=myisam---unikanie-repair-with-keycache>MyISAM - unikanie repair with keycache</h2><p>Gdy nasza baza urośnie i będziemy mieć w niej tabele o rozmiarze przekraczającym 2GB to da się zauważyć że pewne operacja jak np. zakładanie indeksu, optymalizacja, naprawa - trwają cholernie długo. Można to szczególnie odczuć właśnie w momencie przekraczania rozmiaru 2GB i tak utworzenie indeksu na tabeli o rozmiarze 1,9GB trwa powiedzmy kilkanaście/kilkadziesiąt minut, a ta sama operacja na bazie o rozmiarze 2,1GB może zająć nawet kilka godzin.</p><p>Przyczynę łatwo namierzyć obserwując wynik polecenia:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SHOW</span> PROCESSLIST;
</code></pre></div><p>w trakcie operacji na &ldquo;małej&rdquo; i &ldquo;dużej&rdquo; tabeli. &ldquo;Mała&rdquo; zatrzymuje się na dłużej na operacji <strong>Repair By Sorting</strong>, a &ldquo;duża&rdquo; kona godzinami na <strong>Repair With Keycache</strong>. Właśnie różnica w działaniu obu mechanizmów sortowania daje w kość:</p><ul><li>repair by sorting - wykorzystuje do sortowania wiele plików tymczasowych i wymaga sporo wolnego miejsca w katalogu ustawionym w opcji tmpdir (domyślnie ustawionej na /tmp) - jeżeli miejsca będzie za mało to wybierany będzie mechanizm &ldquo;repair with keycache&rdquo;,</li><li>repair with keycache - wykorzystuje do sortowania bardzo mały bufor (u mnie 8MB), jest ok 10~20 krotnie wolniejszy niż &ldquo;repair by sorting&rdquo; a do tego tworzy mniej optymalne indeksy.</li></ul><p>O tym który z mechanizmów zostanie wybrany decyduje opcja <strong><em>myisam_max_sort_file_size</em></strong> - zmienna ta ma domyślnie wartość 2GB i właśnie dlatego problemy pojawiają się po przekroczeniu tego rozmiaru. Proponuję ustawić ją sporo powyżej rozmiaru największych tablic - oczywiście jeśli miejsce w temp&rsquo;ie pozwoli na to, np:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>myisam_max_sort_file_size=8GB
</code></pre></div><p>Przy takim ustawieniu warto mieć w /tmp minimum drugie tyle wolnego miejsca.</p><h5 id=źródło>Źródło</h5><p><a href=http://dba.stackexchange.com/questions/3163/mysql-5-1-innodb-configuration-24gb-ram-bi-xeon-high-load>http://dba.stackexchange.com/questions/3163/mysql-5-1-innodb-configuration-24gb-ram-bi-xeon-high-load</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>Categories: </span><a class=category href=/categories/howto/>HOWTO</a></div><div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59A2 2 0 0120.59 13.41z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=screen-reader-text>Tags: </span><a class=tag href=/tags/mariadb/>MariaDB</a>, <a class=tag href=/tags/mysql/>MySQL</a>, <a class=tag href=/tags/percona/>Percona</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/2011/11/fail2ban-regulki-dla-dovecota/><span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>Previous</span>
<span class=screen-reader-text>Previous post: </span>fail2ban - regułki dla dovecot’a</a></div><div class="next-entry sep-before"><a href=/2011/12/konfiguracja-modemu-usb-iplus-na-urzadzeniach-fortigate/><span class=screen-reader-text>Next post: </span>Konfiguracja modemu USB iPlus na urządzeniach FortiGate<span aria-hidden=true>Next<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label="Social Menu"><ul><li><a href=https://github.com/tgagor target=_blank rel="noopener me"><span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=https://linkedin.com/in/tgagor target=_blank rel="noopener me"><span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></li><li><a href=https://timor.site/index.xml target=_blank rel="noopener me"><span class=screen-reader-text>Open Rss account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2011-2021 TiMoR</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.c3bcf2df.js></script></body></html>