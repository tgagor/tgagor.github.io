<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HOWTO | Tom's Blog</title>
<meta name=keywords content><meta name=description content="pages for taxonomy (classification) term: howto"><meta name=author content="timor"><link rel=canonical href=https://gagor.pro/categories/howto/><link crossorigin=anonymous href=/assets/css/stylesheet.985a7641e69c6b20f34bf2fd88dce5a50d271007390e15128242aada21b132f4.css integrity="sha256-mFp2QeacayDzS/L9iNzlpQ0nEAc5DhUSgkKq2iGxMvQ=" rel="preload stylesheet" as=style><link rel=icon href=https://gagor.pro/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gagor.pro/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gagor.pro/favicon-32x32.png><link rel=apple-touch-icon href=https://gagor.pro/apple-touch-icon.png><link rel=mask-icon href=https://gagor.pro/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gagor.pro/categories/howto/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://gagor.pro/categories/howto/"><meta property="og:site_name" content="Tom's Blog"><meta property="og:title" content="HOWTO"><meta property="og:description" content="Linux configuration, Automation, Security - Sysadmin/DevOps blog"><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta name=twitter:card content="summary"><meta name=twitter:title content="HOWTO"><meta name=twitter:description content="Linux configuration, Automation, Security - Sysadmin/DevOps blog"></head><body class="list dark" id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gagor.pro/ accesskey=h title="Tom's Blog (Alt + H)"><img src=https://gagor.pro/favicon-36x36.avif alt="Page logo" aria-label=logo height=36 width=36>Tom's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://gagor.pro/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://gagor.pro/projects/ title=Projects><span>Projects</span></a></li><li><a href=https://gagor.pro/bookshelf/ title=Bookshelf><span>Bookshelf</span></a></li><li><a href=https://gagor.pro/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://gagor.pro/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=https://gagor.pro/>Home</a>&nbsp;»&nbsp;<a href=https://gagor.pro/categories/>Categories</a></div><h1>HOWTO</h1></header><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>MySQL - Proste metody optymalizacji</h2></header><div class=entry-content><p>Wcześniej czy później zawsze pojawia się potrzeba zoptymalizowania naszej bazy MySQL. Przedstawię kilka zmian w konfiguracji, które powinny zwiększyć wydajność w większości przypadków.
MyISAM - key_buffer_size Najprostszą optymalizacją baz/tabel z mechanizmem MyISAM jest odpowiednie dobranie bufora na cache dla kluczy i indeksów (dane nigdy nie są cachowane). Poniższe zapytanie pozwala oszacować zalecany rozmiar cache’u:
SELECT CONCAT(ROUND(KBS/POWER(1024, IF(PowerOf1024&lt;0,0,IF(PowerOf1024>3,0,PowerOf1024)))+0.4999), SUBSTR(' KMG',IF(PowerOf1024&lt;0,0, IF(PowerOf1024>3,0,PowerOf1024))+1,1)) recommended_key_buffer_size FROM (SELECT LEAST(POWER(2,32),KBS1) KBS FROM (SELECT SUM(index_length) KBS1 FROM information_schema.tables WHERE engine='MyISAM' AND table_schema NOT IN ('information_schema','mysql')) AA ) A, (SELECT 2 PowerOf1024) B; Wynik określa zalecany rozmiar bufora (parametr key_buffer_size w pliku /etc/mysql/my.cnf) dla bieżącego stanu bazy - warto ciut dodać na zapas. Na systemach 32 bitowych parametr key_buffer_size może przyjmować maksymalnie 4GB, na 64 bitowych maksymalnie 8GB.
...</p></div><footer class=entry-footer><span title='2011-12-29 00:00:00 +0000 UTC'>2011-12-29</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to MySQL - Proste metody optymalizacji" href=https://gagor.pro/2011/12/mysql-proste-metody-optymalizacji/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>fail2ban - regułki dla dovecot’a</h2></header><div class=entry-content><p>Domyślna konfiguracja fail2ban’a (na Debianie) nie zawiera reguł pozwalających na blokowanie prób włamań na skrzynki POP/IMAP dla dovecota (no chyba że korzystamy z saslauthd). Można szybko utworzyć własny zestaw filtrów co przedstawię poniżej.
Tworzymy plik: /etc/fail2ban/filter.d/dovecot.conf
[Definition] failregex = (?: pop3-login|imap-login): .*(?:Authentication failure|Aborted login \(auth failed|Aborted login \(tried to use disabled|Disconnected \(auth failed|Aborted login \(\d+ authentication attempts).*rip=(?P&lt;host>\S*),.* ignoreregex = Później dopisujemy na końcu pliku: /etc/fail2ban/jail.conf
[dovecot] enabled = true filter = dovecot port = pop3,pop3s,imap,imaps logpath = /var/log/mail.log maxretry = 20 # te dwa poniżej wedle uznania - ja mam dobrze ustawione default'y #findtime = 1200 #bantime = 1200 Zostało zrestartować fail2ban’a:
...</p></div><footer class=entry-footer><span title='2011-11-28 00:00:00 +0000 UTC'>2011-11-28</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to fail2ban - regułki dla dovecot’a" href=https://gagor.pro/2011/11/fail2ban-regulki-dla-dovecota/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>X-Forwarded-For + mod_rpaf - logowanie rzeczywistych adresów IP na Apache za reverse proxy</h2></header><div class=entry-content><p>Gdy już ustawimy reverse proxy przed Apache szybko można zauważyć że w logach zamiast adresów IP zdalnych użytkowników pojawia się tylko jeden adres: adres naszego proxy. Również z poziomu php’a jako adres klienta widać IP naszego proxy.
By poradzić sobie z tym problemem trzeba na serwerze reverse proxy ustawić przekazywanie informacji o oryginalnym adresie IP klienta w nagłówku X-Forwarded-For. W przypadku gdy reverse proxy działa na nginx’e wystarczy dodać taki wpis:
...</p></div><footer class=entry-footer><span title='2011-11-28 00:00:00 +0000 UTC'>2011-11-28</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to X-Forwarded-For + mod_rpaf - logowanie rzeczywistych adresów IP na Apache za reverse proxy" href=https://gagor.pro/2011/11/x-forwarded-for-mod_rpaf-logowanie-rzeczywistych-adresow-ip-na-apache-za-reverse-proxy/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Porównanie optymalizatorów PHP - eAccelerator, PHP APC, XCache</h2></header><div class=entry-content><p>Przez pewien czas korzystałem z eAcceleratora do przyspieszenia działania stron pisanych w PHP’ie ale czasem bywał niestabilny. Aktualizacje pojawiały się rzadko a od czasu do czasu miewałem problemy ze stabilnością tej wtyczki na kilku bardziej skomplikowanych aplikacjach. Zdarzało się że pomimo zmiany kodu w skrypcie php, eAccelerator serwował wciąż stary plik - konieczny był restart Apache’go by wszystko działało jak trzeba.
Zacząłem szukać alternatywy i trafiłem na dwa moduły:
APC  external link (czyli Alternative PHP Cache), który ma być nawet domyślnie wbudowany w PHP od wersji 5.4, XCache  external link - projekt rozwijany przez jednego z programistów lighttpd. Byłem ciekaw wydajności poszczególnych rozwiązań względem siebie, więc przygotowałem małe środowisko testowe składające się z 4 maszyn wirtualnych (działających pod kontrolą VirtualBox’a):
...</p></div><footer class=entry-footer><span title='2011-11-02 00:00:00 +0000 UTC'>2011-11-02</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to Porównanie optymalizatorów PHP - eAccelerator, PHP APC, XCache" href=https://gagor.pro/2011/11/porownanie-optymalizatorow-php-eaccelerator-php-apc-xcache/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>SLES 11 - instalacja Service Pack’a</h2></header><div class=entry-content><p>Administrowałem do tej pory głównie darmowymi distro, ale gdzieś tam ukradkiem wkradło się kilka “siusiaków” (aka SUSE Linux Enterprise Server). Żyłem w utopijnym przekonaniu że skoro się za nie płaci to powinno się z nimi łatwiej współpracować… w przypadku instalacji aktualizacji (a w szczególności SP) nie było to aż takie proste.
Przywykłem w darmowych dystrybucjach że gdy pojawiała się nowszą “większa wersja” to po prostu można było jednym poleceniem zaktualizować wszystkie pakiety. Źródła aktualizowały się automatycznie (lub prawie automatycznie) - później trzeba było połatać ewentualne zmiany w plikach konfiguracyjnych. W SUSE jest ciut inaczej… 😉
...</p></div><footer class=entry-footer><span title='2011-10-20 00:00:00 +0000 UTC'>2011-10-20</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to SLES 11 - instalacja Service Pack’a" href=https://gagor.pro/2011/10/sles-11-instalacja-service-packa/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Ochrona usług przed atakami brute force z fail2ban’em</h2></header><div class=entry-content><p>Bardzo często konfigurując usługi dostępne publicznie poświęca się sporo czasu na maksymalne zwiększenie bezpieczeństwa przez “dopieszczanie” konfiguracji (certyfikaty z mocnym szyfrowaniem, ochronę pewnych stron hasłem, dostęp do SSH tylko kluczami, itd.) ale całkowicie pomija się przygotowanie systemu aktywnie monitorującego błędne próby autoryzacji. Oczywiście nie można umniejszać wagi pierwszego z wymienionych etapów ale zdecydowanie nie powinno pomijać się też tego drugiego. Przecież każdy admin chciałby wiedzieć gdy ktoś próbuje włamać się na jego serwer (FTP, HTTP, SSH, itp.) - tylko ilu z Nas zadaje sobie trud by uruchomić taki system?
...</p></div><footer class=entry-footer><span title='2011-10-03 00:00:00 +0000 UTC'>2011-10-03</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to Ochrona usług przed atakami brute force z fail2ban’em" href=https://gagor.pro/2011/10/ochrona-uslug-przed-atakami-brute-force-z-fail2banem/></a></article><article class="post-entry tag-entry"><figure class=entry-cover><img loading=lazy srcset="https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover_hu11870884141080682765.webp 360w ,https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover_hu4595286003930224636.webp 480w ,https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover_hu14249148564451053383.webp 720w ,https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover_hu12566962171481141332.webp 1080w ,https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover_hu4942834801360976519.webp 1500w ,https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover.webp 1500w" sizes="(min-width: 768px) 720px, 100vw" src=https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/images/cover.webp alt=[Postfix](https://www.postfix.org) width=1500 height=625></figure><header class=entry-header><h2 class=entry-hint-parent>pflogsumm - Mail Statistics for Postfix</h2></header><div class=entry-content><p>If you administer even a small mail server, you are surely aware that you cannot monitor logs in real-time. It is difficult to catch, for instance, a problem in communication with a certain domain. It is also hard to estimate the scale of traffic on the server in terms of both the number and volume of emails. It’s challenging to choose the domains for which it would be worthwhile to disable greylisting, etc…
...</p></div><footer class=entry-footer><span title='2011-09-22 00:00:00 +0000 UTC'>2011-09-22</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to pflogsumm - Mail Statistics for Postfix" href=https://gagor.pro/2011/09/pflogsumm-mail-statistics-for-postfix/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>fsck.ext4 - Błąd podczas przydzielania struktury icount: Memory allocation failed</h2></header><div class=entry-content><p>Miałem ostatnio dziwną przygodę: pewien serwer do backupu gdzie ląduje dużo małych plików i dodatkowo tworzonych jest sporo hardlinków zaliczył pada. Co prawda starałem się go grzecznie położyć z pomocą Magic SysRq ale ponieważ nie wiedziałem co było przyczyną awarii fsck wydawał się wskazany.
Podczas próby uruchomienia fsck.ext4 na systemie plików o rozmiarze ok 14TB z kilkuset milionami plików po kilkudziesięciu sekundach otrzymywałem komunikat:
Błąd podczas przydzielania struktury icount: Memory allocation failed
...</p></div><footer class=entry-footer><span title='2011-09-21 00:00:00 +0000 UTC'>2011-09-21</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to fsck.ext4 - Błąd podczas przydzielania struktury icount: Memory allocation failed" href=https://gagor.pro/2011/09/fsck-ext4-blad-podczas-przydzielania-struktury-icount-memory-allocation-failed/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>Magic SysRq - bezpieczny reset Linux’a</h2></header><div class=entry-content><p>Pomimo iż Linux uchodzi za stabilne środowisko to raz na jakiś czas trafi się ciężka zwiecha - z powodu przeciążenia, awarii sprzętu… nieistotne…
Załóżmy że licho wzięło za cel główny serwer plików lub bazę danych dla wielu, wielu stron internetowych. Dostać się po ssh nie możemy bo lecą timeout’y, a siedząc bezpośrednio przy klawiaturze konsola nie reaguje. Mimo to coś ostro daje po dyskach, więc ewentualny twardy reset to na bank utrata części plików… jeśli system po nim w ogóle wstanie… 😑
...</p></div><footer class=entry-footer><span title='2011-09-17 00:00:00 +0000 UTC'>2011-09-17</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to Magic SysRq - bezpieczny reset Linux’a" href=https://gagor.pro/2011/09/magic-sysrq-bezpieczny-reset-linuxa/></a></article><article class="post-entry tag-entry"><header class=entry-header><h2 class=entry-hint-parent>approx - cachujące proxy dla repozytoriów Debiana</h2></header><div class=entry-content><p>Wielu administratorów gdy zaczyna swoją przygodę zarządza jedną/dwoma maszynami… Po pewnym czasie jest ich już kilka… W którymś momencie dostrzega się zalety wirtualizacji i na kilku maszynach fizycznych działa kilkanaście czy kilkadziesiąt maszyn wirtualnych. W takiej sytuacji pobieranie aktualizacji dla wszystkich maszyn potrafi mocno zabić łącze.
I w tym momencie zaczynamy się zastanawiać czy może nie warto byłoby zrobić własnego mirror’a paczek dla naszego ulubionego distro… do prywatnego użytku… synchronizowanego w nocy by nikomu nie przeszkadzać… i dostępnego nawet gdy będziemy offline… Zaczynamy liczyć miejsce i okazuje się że repozytorium Debiana dla architektury i386 to prawie 60GB (sic!), no ale mamy kilka maszynek z arch amd64 i tutaj też prawie 60GB - auć. W tym miejscu wielu dochodzi do wniosku że to jeszcze nie pora na własnego mirror’a 😃
...</p></div><footer class=entry-footer><span title='2011-09-16 00:00:00 +0000 UTC'>2011-09-16</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;timor</footer><a class=entry-link aria-label="post link to approx - cachujące proxy dla repozytoriów Debiana" href=https://gagor.pro/2011/09/approx-cachujace-proxy-dla-repozytoriow-debiana/></a></article><footer class=page-footer><nav class=pagination><a class=prev href=https://gagor.pro/categories/howto/page/16/>«&nbsp;Prev&nbsp;
</a><a class=next href=https://gagor.pro/categories/howto/page/18/>Next&nbsp;&nbsp;»</a></nav></footer></main><footer class=footer><span><a href=https://gagor.pro/>Tom's Blog</a> &copy; 2008-2024</span>
<span>Content licensed under <a rel="license noopener noreferrer" target=_blank href=https://creativecommons.org/licenses/by-sa/4.0/>(CC BY-SA 4.0)</a></span></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "8d51d5292abd4c77bad90db038659671"}'></script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>